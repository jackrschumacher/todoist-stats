<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todoist Analytics Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect x='8' y='8' width='112' height='112' rx='28' fill='%23e44232'/%3E%3Cpath d='M36 68 L58 90 L94 38' stroke='white' stroke-width='14' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3Ccircle cx='94' cy='38' r='9' fill='white'/%3E%3C/svg%3E">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --bg-color:#f4f6f8; --card-bg:#ffffff; --text-main:#2c3e50; --text-muted:#7f8c8d; --primary:#e44232; --primary-hover:#c0392b; --border:#e1e8ed; --highlight:#ffe0dd; --selected-border:#e44232; --modal-overlay:rgba(0,0,0,0.5); }
        [data-theme="dark"] { --bg-color:#1a1a1a; --card-bg:#2d2d2d; --text-main:#ecf0f1; --text-muted:#bdc3c7; --primary:#ff6b6b; --primary-hover:#ff5252; --border:#404040; --highlight:#3d3d3d; --selected-border:#ff6b6b; --modal-overlay:rgba(0,0,0,0.8); }
        body { margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; background-color:var(--bg-color); color:var(--text-main); transition:background 0.3s,color 0.3s; padding-bottom:70px; }
        .container { max-width:1200px; margin:0 auto; padding:20px; }
        .hidden { display:none!important; }
        .flex { display:flex; align-items:center; }
        .between { justify-content:space-between; }
        .gap-10 { gap:10px; }
        .btn { padding:8px 16px; border-radius:6px; border:none; cursor:pointer; font-size:14px; font-weight:600; transition:0.2s; display:inline-flex; align-items:center; gap:8px; text-decoration:none; }
        .btn-sm { padding:4px 10px; font-size:12px; }
        .btn-primary { background:var(--primary); color:white; }
        .btn-primary:hover { background:var(--primary-hover); }
        .btn-outline { background:transparent; border:1px solid var(--border); color:var(--text-main); }
        .btn-outline:hover { background:var(--border); }
        .card { background:var(--card-bg); border-radius:12px; padding:20px; box-shadow:0 4px 6px rgba(0,0,0,0.05); margin-bottom:20px; border:1px solid var(--border); }
        .heatmap-container { max-height:400px; overflow-y:auto; border:1px solid var(--border); border-radius:8px; padding:10px; background:var(--card-bg); scrollbar-width:thin; scrollbar-color:var(--text-muted) transparent; }
        .heatmap-container::-webkit-scrollbar { width:6px; }
        .heatmap-container::-webkit-scrollbar-thumb { background-color:var(--text-muted); border-radius:3px; }
        .heatmap-month-wrapper { margin-bottom:15px; }
        .heatmap-month-label { font-size:13px; font-weight:bold; margin-bottom:5px; color:var(--text-muted); cursor:pointer; display:inline-block; transition:0.2s; padding:2px 8px; border-radius:4px; }
        .heatmap-month-label:hover { color:var(--primary); background:var(--highlight); }
        .heatmap-month-label.selected { color:white; background:var(--primary); }
        .calendar-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; }
        .cal-day { aspect-ratio:1; border-radius:4px; display:flex; justify-content:center; align-items:center; cursor:pointer; border:1px solid transparent; position:relative; font-size:10px; font-weight:bold; color:var(--text-main); }
        .cal-day:hover { border-color:var(--text-muted); transform:scale(1.1); z-index:2; }
        .cal-day.selected { border:2px solid var(--selected-border); transform:scale(1.1); z-index:3; }
        .cal-day.empty { background:transparent; cursor:default; pointer-events:none; }
        .heat-0 { background:var(--bg-color); color:var(--text-muted); opacity:0.5; }
        .heat-1 { background:rgba(228,66,50,0.15); }
        .heat-2 { background:rgba(228,66,50,0.35); }
        .heat-3 { background:rgba(228,66,50,0.55); color:white; }
        .heat-4 { background:rgba(228,66,50,0.75); color:white; }
        .heat-5 { background:#e44232; color:white; }
        .dashboard-grid { display:grid; grid-template-columns:350px 1fr; gap:20px; }
        @media (max-width:900px) { .dashboard-grid { grid-template-columns:1fr; } }
        .stat-tiles { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px; }
        .stat-tile { background:var(--card-bg); padding:15px; border-radius:8px; border:1px solid var(--border); text-align:center; }
        .stat-num { font-size:24px; font-weight:800; color:var(--text-main); }
        .stat-lbl { font-size:11px; text-transform:uppercase; color:var(--text-muted); font-weight:700; margin-top:5px; }
        .chart-container { position:relative; height:250px; width:100%; }
        .login-box { max-width:500px; margin:80px auto; text-align:center; }
        input[type="password"] { width:100%; padding:12px; border:1px solid var(--border); background:var(--card-bg); color:var(--text-main); border-radius:6px; margin-bottom:15px; box-sizing:border-box; }
        .progress-track { height:6px; background:var(--border); border-radius:3px; overflow:hidden; margin-top:10px; }
        .progress-fill { height:100%; background:var(--primary); width:0%; transition:width 0.3s; }
        .community-bar { position:fixed; bottom:0; left:0; width:100%; background:var(--card-bg); border-top:1px solid var(--border); padding:10px 20px; font-size:12px; color:var(--text-muted); display:flex; justify-content:center; gap:20px; box-shadow:0 -2px 10px rgba(0,0,0,0.05); z-index:100; cursor:pointer; transition:background 0.2s; }
        .community-bar:hover { background:var(--border); }
        .comm-stat strong { color:var(--primary); font-size:14px; margin-left:4px; }
        .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:var(--modal-overlay); z-index:2000; display:flex; justify-content:center; align-items:center; }
        .modal-content { background:var(--card-bg); width:95%; max-width:800px; border-radius:12px; padding:25px; box-shadow:0 10px 25px rgba(0,0,0,0.2); position:relative; max-height: 90vh; overflow-y: auto; }
        #toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(20px); background:#333; color:white; padding:12px 24px; border-radius:30px; font-weight:600; box-shadow:0 5px 15px rgba(0,0,0,0.2); opacity:0; pointer-events:none; transition:opacity 0.3s, transform 0.3s; z-index:3000; }
        #toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
        .task-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
        .task-item:last-child { border-bottom: none; }
        .task-content { flex: 1; margin-right: 15px; line-height: 1.4; }
        .task-project { font-size: 10px; background: var(--highlight); color: var(--primary); padding: 3px 8px; border-radius: 4px; font-weight: bold; white-space: nowrap; }
    </style>
</head>
<body>

<div id="toast"></div>

<div class="community-bar" onclick="window.openCommunityModal()">
    <div class="comm-stat">Tasks: <strong id="global-tasks">...</strong></div>
    <div class="comm-stat">Projects: <strong id="global-projects">...</strong></div>
    <div class="comm-stat">Wrappeds: <strong id="global-wrappeds">...</strong></div>
</div>

<div id="community-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="flex between" style="margin-bottom: 20px;">
            <h2 style="margin:0; color: var(--primary);">Community Stats</h2>
            <button onclick="window.closeCommunityModal()" class="btn btn-outline btn-sm"><i class="fa-solid fa-times"></i></button>
        </div>
        <div class="stat-tiles" style="grid-template-columns: repeat(3, 1fr);">
            <div class="stat-tile"><div class="stat-num" id="comm-total">...</div><div class="stat-lbl">Tasks</div></div>
            <div class="stat-tile"><div class="stat-num" id="comm-projects">...</div><div class="stat-lbl">Projects</div></div>
            <div class="stat-tile"><div class="stat-num" id="comm-avg">...</div><div class="stat-lbl">Daily Avg</div></div>
        </div>
        <div class="card" style="margin-top:20px;">
            <h3 style="margin-top:0; font-size:14px; color:var(--text-muted); text-transform:uppercase;">Global Activity</h3>
            <div class="chart-container" style="height:180px;"><canvas id="comm-chart"></canvas></div>
        </div>
    </div>
</div>

<div id="view-login" class="container login-box">
    <div class="card">
        <h1><i class="fa-solid fa-layer-group"></i> Todoist Analytics</h1>
        <p style="color: var(--text-muted);">Visualize your productivity history.</p>
        <input type="password" id="api-token" placeholder="Paste API Token">
        <button onclick="window.initFetch()" class="btn btn-primary" style="width: 100%; justify-content: center;">Load Data</button>
        <div id="loading-ui" class="hidden" style="margin-top: 20px;">
            <div class="flex between" style="font-size: 12px;"><span>Fetching history...</span><span id="load-count">0</span></div>
            <div class="progress-track"><div id="progress-bar" class="progress-fill"></div></div>
            <div id="error-msg" style="color: red; font-size: 12px; margin-top: 10px;"></div>
        </div>
    </div>
</div>

<div id="view-dashboard" class="container hidden">
    <div class="flex between" style="margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px;">
        <div class="flex gap-10">
            <h2 style="margin:0; color: var(--primary);">Analytics</h2>
            <div id="filter-badge" style="background: var(--text-main); color: var(--bg-color); padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold;">All Time</div>
            <button id="btn-reset" onclick="window.resetFilter()" class="hidden btn btn-outline btn-sm"><i class="fa-solid fa-times"></i> Clear</button>
        </div>
        <div class="flex gap-10">
            <a href="wrapped.html" class="btn btn-primary btn-sm"><i class="fa-solid fa-gift"></i> Wrapped</a>
            <button onclick="window.toggleTheme()" class="btn btn-outline btn-sm"><i id="theme-icon" class="fa-solid fa-moon"></i></button>
            <button onclick="window.resyncData()" class="btn btn-outline btn-sm"><i class="fa-solid fa-rotate"></i></button>
            <button onclick="window.logout()" class="btn btn-outline btn-sm"><i class="fa-solid fa-sign-out-alt"></i></button>
        </div>
    </div>

    <div class="dashboard-grid">
        <div>
            <div class="card">
                <h3 style="margin:0; font-size:16px; margin-bottom:10px;">History Heatmap</h3>
                <div id="heatmap-scroll-area" class="heatmap-container"><div id="full-heatmap-content"></div></div>
            </div>
            <div class="stat-tiles">
                <div class="stat-tile"><div class="stat-num" id="stat-count">0</div><div class="stat-lbl">Tasks</div></div>
                <div class="stat-tile"><div class="stat-num" id="stat-avg">0</div><div class="stat-lbl">Daily Avg</div></div>
            </div>
        </div>
        <div>
            <div class="card">
                <h3 id="chart-title-timeline" style="margin:0; font-size:16px;">Activity Timeline</h3>
                <div class="chart-container"><canvas id="chart-timeline"></canvas></div>
            </div>
            <div id="tasks-detail-card" class="card hidden">
                <div class="flex between" style="margin-bottom:15px;">
                    <h3 id="tasks-detail-title" style="margin:0; font-size:16px; color:var(--primary);">Daily Tasks</h3>
                    <span id="tasks-count-badge" style="font-size:11px; background:var(--border); padding:2px 8px; border-radius:10px;">0 tasks</span>
                </div>
                <div id="tasks-list"></div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, update, increment, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCtr9BAKgKj4eHqk5lCaDlrASZubFncYqA",
        authDomain: "todoist-stats-cd36f.firebaseapp.com",
        databaseURL: "https://todoist-stats-cd36f-default-rtdb.firebaseio.com",
        projectId: "todoist-stats-cd36f",
        storageBucket: "todoist-stats-cd36f.firebasestorage.app",
        messagingSenderId: "836832717528",
        appId: "1:836832717528:web:e01ff49d10969d429e05ad"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const API_URL = 'https://api.todoist.com/sync/v9/completed/get_all';
    
    let STATE = {
        allTasks: [], filteredTasks: [], taskMap: {}, projectMap: {}, charts: {}, filterType: 'ALL', filterValue: null, isAuthReady: false
    };

    // Global Stats Listener
    onValue(ref(db, 'global_stats'), (snapshot) => {
        const data = snapshot.val(); if (!data) return;
        document.getElementById('global-tasks').innerText = (data.tasks_processed || 0).toLocaleString();
        document.getElementById('global-projects').innerText = (data.projects_processed || 0).toLocaleString();
        document.getElementById('global-wrappeds').innerText = (data.wrappeds_generated || 0).toLocaleString();
        document.getElementById('comm-total').innerText = (data.tasks_processed || 0).toLocaleString();
        document.getElementById('comm-projects').innerText = (data.projects_processed || 0).toLocaleString();
        const totalDays = data.total_days_logged || 1;
        document.getElementById('comm-avg').innerText = (data.tasks_processed / totalDays).toFixed(1);
    });

    onValue(ref(db, 'community_monthly'), (snapshot) => {
        const data = snapshot.val(); if (!data) return;
        const keys = Object.keys(data).sort();
        drawCommunityChart('comm-chart', keys, keys.map(k => data[k]));
    });

    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("ðŸ”¥ Firebase Auth Ready:", user.uid);
            STATE.isAuthReady = true;
            const token = localStorage.getItem('todoist_token');
            if (token) {
                document.getElementById('api-token').value = token;
                window.initFetch();
            }
        } else { 
            console.log("...Signing in anonymously...");
            signInAnonymously(auth).catch(console.error); 
        }
    });

    window.onload = () => {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            if (savedTheme === 'dark') window.applyTheme('dark');
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                window.applyTheme('dark');
            }
        }
        const projCache = localStorage.getItem('todoist_projects_cache');
        if (projCache) STATE.projectMap = JSON.parse(projCache);
    };

    window.initFetch = async function(resync = false) {
        const token = document.getElementById('api-token').value.trim();
        if (!token) return;

        if (!resync) {
            const cached = localStorage.getItem('todoist_task_cache');
            if (cached) {
                STATE.allTasks = JSON.parse(cached);
                processData();
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('view-dashboard').classList.remove('hidden');
                if(STATE.isAuthReady) calculateDeltas();
                else setTimeout(() => { if(STATE.isAuthReady) calculateDeltas(); }, 2000);
                return;
            }
        }

        document.getElementById('loading-ui').classList.remove('hidden');
        STATE.allTasks = [];
        let offset = 0, hasMore = true;

        try {
            const projRes = await fetch('https://api.todoist.com/sync/v9/sync', {
                method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ sync_token: '*', resource_types: ['projects'] })
            });
            const projData = await projRes.json();
            projData.projects.forEach(p => STATE.projectMap[p.id] = p.name);
            localStorage.setItem('todoist_projects_cache', JSON.stringify(STATE.projectMap));

            while(hasMore) {
                const res = await fetch(`${API_URL}?limit=200&offset=${offset}`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if(data.items.length > 0) {
                    STATE.allTasks = STATE.allTasks.concat(data.items);
                    offset += 200;
                    document.getElementById('load-count').innerText = STATE.allTasks.length;
                } else { hasMore = false; }
            }

            localStorage.setItem('todoist_token', token);
            localStorage.setItem('todoist_task_cache', JSON.stringify(STATE.allTasks));
            processData();
            
            if (STATE.isAuthReady) calculateDeltas();
            else setTimeout(() => calculateDeltas(), 1000);

            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-dashboard').classList.remove('hidden');
        } catch (e) { alert("Fetch failed: " + e.message); }
        document.getElementById('loading-ui').classList.add('hidden');
    }

    function calculateDeltas() {
        if (!STATE.isAuthReady) {
            console.warn("Auth not ready, skipping stats sync.");
            return;
        }

        const lastStr = localStorage.getItem('todoist_last_sync_stats');
        const last = lastStr ? JSON.parse(lastStr) : { tasks: 0, projects: 0, months: {} };
        const currentTasks = STATE.allTasks.length;
        const currentProjects = Object.keys(STATE.projectMap).length;

        const currentMonths = {};
        STATE.allTasks.forEach(t => {
            const m = t.completed_at.substring(0, 7);
            currentMonths[m] = (currentMonths[m] || 0) + 1;
        });

        const updates = {};
        let hasUpdates = false;

        if (currentTasks > last.tasks) {
            updates['global_stats/tasks_processed'] = increment(currentTasks - last.tasks);
            hasUpdates = true;
        }
        if (currentProjects > last.projects) {
            updates['global_stats/projects_processed'] = increment(currentProjects - last.projects);
            hasUpdates = true;
        }

        for (const [month, count] of Object.entries(currentMonths)) {
            const lastCount = last.months && last.months[month] ? last.months[month] : 0;
            const diff = count - lastCount;
            if (diff > 0) {
                updates[`community_monthly/${month}`] = increment(diff);
                hasUpdates = true;
            }
        }

        if (hasUpdates) {
            update(ref(db), updates)
                .then(() => {
                    console.log("âœ… Stats synced to Firebase!");
                    localStorage.setItem('todoist_last_sync_stats', JSON.stringify({ 
                        tasks: currentTasks, 
                        projects: currentProjects,
                        months: currentMonths 
                    }));
                })
                .catch((e) => {
                    console.error("âŒ Stats sync failed:", e);
                });
        } else {
            console.log("No new stats to sync.");
        }
    }

    window.forceProjectSync = function() {
        localStorage.removeItem('todoist_last_sync_stats');
        calculateDeltas();
    }

    function processData() {
        STATE.taskMap = {};
        STATE.allTasks.forEach(t => {
            const d = t.completed_at.substring(0, 10);
            STATE.taskMap[d] = (STATE.taskMap[d] || 0) + 1;
        });
        renderHeatmap();

        // DEFAULT VIEW: ALL TIME (Tasks per month)
        window.setFilter('ALL', null);
        
        // Auto-scroll to bottom of heatmap
        setTimeout(() => {
             const el = document.getElementById('heatmap-scroll-area');
             if(el) el.scrollTop = el.scrollHeight;
        }, 100);
    }

    function renderHeatmap() {
        const container = document.getElementById('full-heatmap-content');
        container.innerHTML = '';
        const dates = STATE.allTasks.map(t => new Date(t.completed_at));
        const min = new Date(Math.min(...dates)), max = new Date();
        let curr = new Date(min.getFullYear(), min.getMonth(), 1);

        while (curr <= max) {
            const wrapper = document.createElement('div');
            wrapper.className = 'heatmap-month-wrapper';
            const label = document.createElement('div');
            label.className = 'heatmap-month-label';
            const monthKey = `${curr.getFullYear()}-${String(curr.getMonth()+1).padStart(2,'0')}`;
            label.innerText = curr.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            label.onclick = () => window.setFilter('MONTH', monthKey);
            
            const grid = document.createElement('div');
            grid.className = 'calendar-grid';
            const days = new Date(curr.getFullYear(), curr.getMonth()+1, 0).getDate();
            const offset = new Date(curr.getFullYear(), curr.getMonth(), 1).getDay();

            for(let i=0; i<offset; i++) grid.appendChild(Object.assign(document.createElement('div'), {className:'cal-day empty'}));
            for(let d=1; d<=days; d++) {
                const ds = `${curr.getFullYear()}-${String(curr.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const count = STATE.taskMap[ds] || 0;
                const day = document.createElement('div');
                const heat = count === 0 ? 0 : Math.min(5, Math.ceil(count/3));
                day.className = `cal-day heat-${heat}`;
                day.innerText = d;
                day.onclick = () => window.setFilter('DAY', ds);
                grid.appendChild(day);
            }
            wrapper.append(label, grid);
            container.appendChild(wrapper);
            curr.setMonth(curr.getMonth()+1);
        }
    }

    window.setFilter = function(type, val) {
        STATE.filterType = type; STATE.filterValue = val;
        document.getElementById('filter-badge').innerText = val || "All Time";
        document.getElementById('btn-reset').classList.toggle('hidden', type === 'ALL');
        
        if (type === 'ALL') STATE.filteredTasks = [...STATE.allTasks];
        else if (type === 'MONTH') STATE.filteredTasks = STATE.allTasks.filter(t => t.completed_at.startsWith(val));
        else if (type === 'DAY') STATE.filteredTasks = STATE.allTasks.filter(t => t.completed_at.startsWith(val));

        updateStats();
        renderTimeline();
        renderTaskList();
    }

    function updateStats() {
        document.getElementById('stat-count').innerText = STATE.filteredTasks.length.toLocaleString();
        const days = new Set(STATE.filteredTasks.map(t => t.completed_at.substring(0,10))).size || 1;
        document.getElementById('stat-avg').innerText = (STATE.filteredTasks.length / days).toFixed(1);
    }

    function renderTimeline() {
        let labels = [], map = {};
        
        if (STATE.filterType === 'ALL') {
             // Show full history range
             const dates = STATE.allTasks.map(t => new Date(t.completed_at));
             if(dates.length === 0) return;
             let curr = new Date(Math.min(...dates));
             curr.setDate(1); 
             const end = new Date(); // Always extend to Today
             while (curr <= end) {
                const k = `${curr.getFullYear()}-${String(curr.getMonth()+1).padStart(2,'0')}`;
                labels.push(k); map[k] = 0;
                curr.setMonth(curr.getMonth() + 1);
             }
             STATE.filteredTasks.forEach(t => {
                const k = t.completed_at.substring(0, 7);
                if(map[k] !== undefined) map[k]++;
             });
             document.getElementById('chart-title-timeline').innerText = "History by Month";

        } else if (STATE.filterType === 'MONTH') {
             // Show all days in the specific month
             const [y, m] = STATE.filterValue.split('-');
             const daysInMonth = new Date(y, m, 0).getDate();
             for(let d=1; d<=daysInMonth; d++) {
                const k = `${y}-${m}-${String(d).padStart(2,'0')}`;
                labels.push(k); map[k] = 0;
             }
             STATE.filteredTasks.forEach(t => {
                const k = t.completed_at.substring(0, 10);
                if(map[k] !== undefined) map[k]++;
             });
             document.getElementById('chart-title-timeline').innerText = "Daily Breakdown";

        } else {
             // Hourly View (Day selected)
             for(let i=0; i<24; i++) {
                const k = `${String(i).padStart(2,'0')}:00`;
                labels.push(k); map[k] = 0;
             }
             STATE.filteredTasks.forEach(t => {
                const h = new Date(t.completed_at).getHours();
                const k = `${String(h).padStart(2,'0')}:00`;
                if(map[k] !== undefined) map[k]++;
             });
             document.getElementById('chart-title-timeline').innerText = "Hourly Breakdown";
        }
        drawChart('chart-timeline', 'bar', labels, labels.map(l => map[l]));
    }

    function renderTaskList() {
        const card = document.getElementById('tasks-detail-card');
        const list = document.getElementById('tasks-list');
        if (STATE.filterType !== 'DAY') { card.classList.add('hidden'); return; }
        card.classList.remove('hidden');
        document.getElementById('tasks-detail-title').innerText = `Tasks on ${STATE.filterValue}`;
        document.getElementById('tasks-count-badge').innerText = STATE.filteredTasks.length;
        list.innerHTML = STATE.filteredTasks.map(t => `
            <div class="task-item">
                <div class="task-content">${t.content}</div>
                <div class="task-project">${STATE.projectMap[t.project_id] || 'Inbox'}</div>
            </div>
        `).join('');
    }

    function drawChart(id, type, labels, data) {
        const ctx = document.getElementById(id).getContext('2d');
        if(STATE.charts[id]) STATE.charts[id].destroy();
        STATE.charts[id] = new Chart(ctx, {
            type, data: { labels, datasets: [{ data, backgroundColor: '#e44232' }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: false } }
        });
    }

    function drawCommunityChart(id, labels, data) {
        const ctx = document.getElementById(id).getContext('2d');
        if(STATE.charts[id]) STATE.charts[id].destroy();
        STATE.charts[id] = new Chart(ctx, {
            type: 'line', data: { labels, datasets: [{ data, borderColor: '#e44232', fill: true, tension: 0.4 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: false } }
        });
    }

    window.resetFilter = () => window.setFilter('ALL', null);
    window.openCommunityModal = () => document.getElementById('community-modal').classList.remove('hidden');
    window.closeCommunityModal = () => document.getElementById('community-modal').classList.add('hidden');
    window.toggleTheme = () => {
        const dark = document.body.getAttribute('data-theme') !== 'dark';
        window.applyTheme(dark ? 'dark' : 'light');
    };
    window.applyTheme = (t) => {
        document.body.setAttribute('data-theme', t);
        localStorage.setItem('theme', t);
        document.getElementById('theme-icon').className = t === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
    };
    window.logout = () => { localStorage.clear(); location.reload(); };
    window.resyncData = () => window.initFetch(true);
</script>
</body>
</html>
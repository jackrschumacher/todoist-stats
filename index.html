<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todoist Analytics Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect x='8' y='8' width='112' height='112' rx='28' fill='%23e44232'/%3E%3Cpath d='M36 68 L58 90 L94 38' stroke='white' stroke-width='14' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3Ccircle cx='94' cy='38' r='9' fill='white'/%3E%3C/svg%3E">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --bg-color:#f4f6f8; --card-bg:#ffffff; --text-main:#2c3e50; --text-muted:#7f8c8d; --primary:#e44232; --primary-hover:#c0392b; --border:#e1e8ed; --highlight:#ffe0dd; --selected-border:#e44232; --modal-overlay:rgba(0,0,0,0.5); }
        [data-theme="dark"] { --bg-color:#1a1a1a; --card-bg:#2d2d2d; --text-main:#ecf0f1; --text-muted:#bdc3c7; --primary:#ff6b6b; --primary-hover:#ff5252; --border:#404040; --highlight:#3d3d3d; --selected-border:#ff6b6b; --modal-overlay:rgba(0,0,0,0.8); }
        body { margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; background-color:var(--bg-color); color:var(--text-main); transition:background 0.3s,color 0.3s; padding-bottom:70px; }
        .container { max-width:1200px; margin:0 auto; padding:20px; }
        .hidden { display:none!important; }
        .flex { display:flex; align-items:center; }
        .between { justify-content:space-between; }
        .gap-10 { gap:10px; }
        .btn { padding:8px 16px; border-radius:6px; border:none; cursor:pointer; font-size:14px; font-weight:600; transition:0.2s; display:inline-flex; align-items:center; gap:8px; text-decoration:none; }
        .btn-sm { padding:4px 10px; font-size:12px; }
        .btn-primary { background:var(--primary); color:white; }
        .btn-primary:hover { background:var(--primary-hover); }
        .btn-outline { background:transparent; border:1px solid var(--border); color:var(--text-main); }
        .btn-outline:hover { background:var(--border); }
        .btn-ghost { background:transparent; color:var(--primary); font-weight:bold; border:1px solid transparent; }
        .btn-ghost:hover { background:var(--highlight); }
        .card { background:var(--card-bg); border-radius:12px; padding:20px; box-shadow:0 4px 6px rgba(0,0,0,0.05); margin-bottom:20px; border:1px solid var(--border); }
        .heatmap-container { max-height:400px; overflow-y:auto; border:1px solid var(--border); border-radius:8px; padding:10px; background:var(--card-bg); scrollbar-width:thin; scrollbar-color:var(--text-muted) transparent; }
        .heatmap-container::-webkit-scrollbar { width:6px; }
        .heatmap-container::-webkit-scrollbar-thumb { background-color:var(--text-muted); border-radius:3px; }
        .heatmap-month-wrapper { margin-bottom:15px; }
        .heatmap-month-label { font-size:13px; font-weight:bold; margin-bottom:5px; color:var(--text-muted); cursor:pointer; display:inline-block; transition:0.2s; padding:2px 8px; border-radius:4px; }
        .heatmap-month-label:hover { color:var(--primary); background:var(--highlight); }
        .heatmap-month-label.selected { color:white; background:var(--primary); }
        .calendar-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; }
        .cal-day { aspect-ratio:1; border-radius:4px; display:flex; justify-content:center; align-items:center; cursor:pointer; border:1px solid transparent; position:relative; font-size:10px; font-weight:bold; color:var(--text-main); }
        .cal-day:hover { border-color:var(--text-muted); transform:scale(1.1); z-index:2; }
        .cal-day.selected { border:2px solid var(--selected-border); transform:scale(1.1); z-index:3; }
        .cal-day.empty { background:transparent; cursor:default; pointer-events:none; }
        .heat-0 { background:var(--bg-color); color:var(--text-muted); opacity:0.5; }
        .heat-1 { background:rgba(228,66,50,0.15); }
        .heat-2 { background:rgba(228,66,50,0.35); }
        .heat-3 { background:rgba(228,66,50,0.55); color:white; }
        .heat-4 { background:rgba(228,66,50,0.75); color:white; }
        .heat-5 { background:#e44232; color:white; }
        .dashboard-grid { display:grid; grid-template-columns:350px 1fr; gap:20px; }
        @media (max-width:900px) { .dashboard-grid { grid-template-columns:1fr; } }
        .stat-tiles { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px; }
        .stat-tile { background:var(--card-bg); padding:15px; border-radius:8px; border:1px solid var(--border); text-align:center; }
        .stat-num { font-size:24px; font-weight:800; color:var(--text-main); }
        .stat-lbl { font-size:11px; text-transform:uppercase; color:var(--text-muted); font-weight:700; margin-top:5px; }
        .chart-container { position:relative; height:250px; width:100%; }
        .login-box { max-width:500px; margin:80px auto; text-align:center; }
        input[type="password"] { width:100%; padding:12px; border:1px solid var(--border); background:var(--card-bg); color:var(--text-main); border-radius:6px; margin-bottom:15px; box-sizing:border-box; }
        .progress-track { height:6px; background:var(--border); border-radius:3px; overflow:hidden; margin-top:10px; }
        .progress-fill { height:100%; background:var(--primary); width:0%; transition:width 0.3s; }
        .community-bar { position:fixed; bottom:0; left:0; width:100%; background:var(--card-bg); border-top:1px solid var(--border); padding:10px 20px; font-size:12px; color:var(--text-muted); display:flex; justify-content:center; gap:20px; box-shadow:0 -2px 10px rgba(0,0,0,0.05); z-index:100; cursor:pointer; transition:background 0.2s; }
        .community-bar:hover { background:var(--border); }
        .comm-stat strong { color:var(--primary); font-size:14px; margin-left:4px; }
        .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:var(--modal-overlay); z-index:2000; display:flex; justify-content:center; align-items:center; }
        .modal-content { background:var(--card-bg); width:95%; max-width:800px; border-radius:12px; padding:25px; box-shadow:0 10px 25px rgba(0,0,0,0.2); position:relative; max-height: 90vh; overflow-y: auto; }
        #toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(20px); background:#333; color:white; padding:12px 24px; border-radius:30px; font-weight:600; box-shadow:0 5px 15px rgba(0,0,0,0.2); opacity:0; pointer-events:none; transition:opacity 0.3s, transform 0.3s; z-index:3000; }
        #toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
    </style>
</head>
<body>

<div id="toast"></div>

<div class="community-bar" onclick="window.openCommunityModal()" title="Click to view global trends">
    <div class="comm-stat">Global Tasks: <strong id="global-tasks">...</strong></div>
    <div class="comm-stat">Exports: <strong id="global-exports">...</strong></div>
    <div class="comm-stat">Wrappeds: <strong id="global-wrappeds">...</strong></div>
    <div style="font-size:10px; align-self:center; opacity:0.7;">(Click for stats)</div>
</div>

<div id="community-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="flex between" style="margin-bottom: 20px;">
            <h2 style="margin:0; color: var(--primary);">Global Community Stats</h2>
            <button onclick="window.closeCommunityModal()" class="btn btn-outline btn-sm"><i class="fa-solid fa-times"></i></button>
        </div>
        <div class="stat-tiles" style="grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div class="stat-tile" style="border-color: var(--border);">
                <div class="stat-num" id="comm-total">...</div>
                <div class="stat-lbl">Global Tasks</div>
            </div>
            <div class="stat-tile" style="border-color: var(--border);">
                <div class="stat-num" id="comm-avg">...</div>
                <div class="stat-lbl">Community Daily Avg</div>
            </div>
        </div>

        <!-- NEW: Global Activity Chart -->
        <div class="card" style="margin-bottom: 20px; padding: 15px;">
            <h3 style="margin-top:0; font-size: 14px; color: var(--text-muted); text-transform:uppercase; margin-bottom: 10px;">Global Growth Trend</h3>
            <div class="chart-container" style="height: 180px;"><canvas id="comm-chart"></canvas></div>
        </div>

        <div class="card" style="background: var(--bg-color); border: 1px solid var(--border); padding: 20px;">
            <h3 style="margin-top:0; font-size: 14px; color: var(--text-muted); text-transform:uppercase; margin-bottom: 15px;">Global Peak Productivity</h3>
            <div class="flex between" style="margin-bottom: 10px; font-size: 16px;">
                <span>Best Time:</span><strong id="comm-best-time" style="font-size: 20px;">-</strong>
            </div>
            <div class="flex between" style="font-size: 16px;">
                <span>Best Weekday:</span><strong id="comm-best-day" style="font-size: 20px;">-</strong>
            </div>
        </div>
    </div>
</div>

<div id="view-login" class="container login-box">
    <div class="card">
        <h1><i class="fa-solid fa-layer-group"></i> Todoist Analytics</h1>
        <p style="color: var(--text-muted);">Visualize your productivity history.</p>
        <input type="password" id="api-token" placeholder="Paste API Token (Settings > Integrations)">
        <button onclick="window.initFetch()" class="btn btn-primary" style="width: 100%; justify-content: center;">Load Data</button>
        <div id="loading-ui" class="hidden" style="margin-top: 20px;">
            <div class="flex between" style="font-size: 12px;"><span>Fetching history...</span><span id="load-count">0</span></div>
            <div class="progress-track"><div id="progress-bar" class="progress-fill"></div></div>
            <div id="error-msg" style="color: red; font-size: 12px; margin-top: 10px;"></div>
        </div>
    </div>
</div>

<div id="view-dashboard" class="container hidden">
    <div class="flex between" style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border);">
        <div class="flex gap-10">
            <h2 style="margin:0; color: var(--primary);">Analytics</h2>
            <div id="filter-badge" style="background: var(--text-main); color: var(--bg-color); padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold;">All Time</div>
            <button id="btn-reset" onclick="window.resetFilter()" class="hidden btn btn-outline btn-sm"><i class="fa-solid fa-times"></i> Clear</button>
        </div>
        <div class="flex gap-10">
            <a href="wrapped.html" class="btn btn-primary" style="font-size: 12px;"><i class="fa-solid fa-gift"></i> Play Wrapped</a>
            <button onclick="window.toggleTheme()" class="btn btn-outline" title="Dark Mode"><i id="theme-icon" class="fa-solid fa-moon"></i></button>
            <button onclick="window.resyncData()" class="btn btn-outline" title="Resync"><i class="fa-solid fa-rotate"></i></button>
            <button onclick="window.logout()" class="btn btn-outline" title="Logout"><i class="fa-solid fa-sign-out-alt"></i></button>
        </div>
    </div>

    <div class="dashboard-grid">
        <div>
            <div class="card">
                <div class="flex between" style="margin-bottom: 10px;">
                    <h3 style="margin:0; font-size: 16px;">History Heatmap</h3>
                    <button class="btn btn-outline btn-sm" onclick="window.exportHeatmap()" title="Export Heatmap"><i class="fa-solid fa-camera"></i> Export</button>
                </div>
                <div style="margin-bottom: 5px; display: grid; grid-template-columns: repeat(7, 1fr); font-size: 10px; color: var(--text-muted); text-align: center;">
                    <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
                </div>
                <div id="heatmap-scroll-area" class="heatmap-container"><div id="full-heatmap-content"></div></div>
                <div style="font-size:11px; color:var(--text-muted); text-align:center; margin-top:8px;">Click a Month or Day to filter charts.</div>
            </div>
            <div class="stat-tiles">
                <div class="stat-tile"><div class="stat-num" id="stat-count">0</div><div class="stat-lbl">Tasks</div></div>
                <div class="stat-tile"><div class="stat-num" id="stat-avg">0</div><div class="stat-lbl">Daily Avg</div></div>
            </div>
             <div class="card">
                <h3 style="margin-top:0; font-size: 14px; color: var(--text-muted); text-transform:uppercase;">Peak Productivity</h3>
                <div class="flex between" style="margin-top: 15px;"><span>Best Time:</span><strong id="stat-best-hour">-</strong></div>
                <div class="flex between" style="margin-top: 10px;"><span>Best Weekday:</span><strong id="stat-best-day">-</strong></div>
            </div>
        </div>
        <div>
            <div class="card">
                <div class="flex between">
                    <h3 id="chart-title-timeline" style="margin:0; font-size: 16px;">Activity Timeline</h3>
                    <button onclick="window.exportChart('chart-timeline')" class="btn btn-outline btn-sm"><i class="fa-solid fa-download"></i></button>
                </div>
                <div class="chart-container"><canvas id="chart-timeline"></canvas></div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="card">
                    <div class="flex between">
                        <h3 style="margin:0; font-size: 14px;">Weekly Pattern</h3>
                        <button onclick="window.exportChart('chart-week')" class="btn btn-outline btn-sm"><i class="fa-solid fa-download"></i></button>
                    </div>
                    <div class="chart-container" style="height: 180px;"><canvas id="chart-week"></canvas></div>
                </div>
                <div class="card">
                    <div class="flex between">
                        <h3 style="margin:0; font-size: 14px;">Hourly Habits</h3>
                        <button onclick="window.exportChart('chart-hours')" class="btn btn-outline btn-sm"><i class="fa-solid fa-download"></i></button>
                    </div>
                    <div class="chart-container" style="height: 180px;"><canvas id="chart-hours"></canvas></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, update, increment, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCtr9BAKgKj4eHqk5lCaDlrASZubFncYqA",
        authDomain: "todoist-stats-cd36f.firebaseapp.com",
        databaseURL: "https://todoist-stats-cd36f-default-rtdb.firebaseio.com",
        projectId: "todoist-stats-cd36f",
        storageBucket: "todoist-stats-cd36f.firebasestorage.app",
        messagingSenderId: "836832717528",
        appId: "1:836832717528:web:e01ff49d10969d429e05ad"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    signInAnonymously(auth).catch(console.error);
    const db = getDatabase(app);
    const API_URL = 'https://api.todoist.com/sync/v9/completed/get_all';
    
    let STATE = {
        allTasks: [], filteredTasks: [], taskMap: {}, filterType: 'ALL', filterValue: null, charts: {}, minDate: new Date(), maxDate: new Date()
    };

    const statsRef = ref(db, 'global_stats');
    const monthlyRef = ref(db, 'community_monthly');

    // Listener for Global Stats
    onValue(statsRef, (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        document.getElementById('global-tasks').innerText = (data.tasks_processed || 0).toLocaleString();
        document.getElementById('global-exports').innerText = (data.exports || 0).toLocaleString();
        document.getElementById('global-wrappeds').innerText = (data.wrappeds_generated || 0).toLocaleString();
        document.getElementById('comm-total').innerText = (data.tasks_processed || 0).toLocaleString();
        const totalDays = data.total_days_logged || 1;
        document.getElementById('comm-avg').innerText = (data.tasks_processed / totalDays).toFixed(1);
        if (data.hours) {
            let maxVal = 0, bestHour = 0;
            for(let i=0; i<24; i++) { if((data.hours[i]||0) > maxVal) { maxVal = data.hours[i]; bestHour = i; } }
            document.getElementById('comm-best-time').innerText = `${bestHour}:00`;
        }
        if (data.weekdays) {
            let maxDayVal = 0, bestDayIndex = 0;
            const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            for(let i=0; i<7; i++) { if((data.weekdays[i]||0) > maxDayVal) { maxDayVal = data.weekdays[i]; bestDayIndex = i; } }
            document.getElementById('comm-best-day').innerText = days[bestDayIndex];
        }
    });

    // NEW: Listener for Community Monthly Trend
    onValue(monthlyRef, (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        
        // Sort keys (YYYY-MM) and prepare labels/data
        const sortedKeys = Object.keys(data).sort();
        const labels = sortedKeys.map(key => {
            const [y, m] = key.split('-');
            const d = new Date(y, parseInt(m) - 1);
            return d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
        });
        const values = sortedKeys.map(key => data[key]);
        
        drawCommunityChart('comm-chart', labels, values);
    });

    function drawCommunityChart(id, labels, data) {
        const ctx = document.getElementById(id).getContext('2d');
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        const textColor = isDark ? '#bdc3c7' : '#2c3e50';
        const gridColor = isDark ? '#404040' : '#eaeaea';
        
        if(STATE.charts[id]) STATE.charts[id].destroy();
        
        STATE.charts[id] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Tasks',
                    data: data,
                    borderColor: '#e44232',
                    backgroundColor: 'rgba(228,66,50,0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: '#e44232'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: textColor, maxRotation: 0 }, grid: { display: false } },
                    y: { beginAtZero: true, ticks: { color: textColor, maxTicksLimit: 5 }, grid: { color: gridColor } }
                }
            }
        });
    }

    window.onload = () => {
        if(localStorage.getItem('theme') === 'dark') window.applyTheme('dark');
        const savedToken = localStorage.getItem('todoist_token');
        if (savedToken) {
            document.getElementById('api-token').value = savedToken;
            window.initFetch();
        }
    };

    window.toggleTheme = function() {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        window.applyTheme(isDark ? 'light' : 'dark');
    }
    window.applyTheme = function(theme) {
        document.body.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        document.getElementById('theme-icon').className = theme === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        if(STATE.filteredTasks.length > 0) renderCharts();
        // Redraw community chart if it exists
        if(STATE.charts['comm-chart']) {
            const chart = STATE.charts['comm-chart'];
            const textColor = theme === 'dark' ? '#bdc3c7' : '#2c3e50';
            const gridColor = theme === 'dark' ? '#404040' : '#eaeaea';
            chart.options.scales.x.ticks.color = textColor;
            chart.options.scales.y.ticks.color = textColor;
            chart.options.scales.y.grid.color = gridColor;
            chart.update();
        }
    }

    window.showToast = function(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    function getLocalISODate(dateStr) {
        const d = new Date(dateStr); 
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    window.initFetch = async function(isResync = false) {
        const token = document.getElementById('api-token').value.trim();
        if (!token) return alert("Please enter API Token");

        if (!isResync) {
            const cached = localStorage.getItem('todoist_task_cache');
            if (cached) {
                try {
                    STATE.allTasks = JSON.parse(cached);
                    processData();
                    document.getElementById('view-login').classList.add('hidden');
                    document.getElementById('view-dashboard').classList.remove('hidden');
                    setTimeout(() => { document.getElementById('heatmap-scroll-area').scrollTop = document.getElementById('heatmap-scroll-area').scrollHeight; }, 100);
                    return; 
                } catch(e) { console.log("Cache error", e); }
            }
        }

        if(!isResync) {
            document.getElementById('view-login').classList.remove('hidden');
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('loading-ui').classList.remove('hidden');
        } else {
            window.showToast("Syncing with Todoist...");
        }
        
        STATE.allTasks = [];
        const taskIds = new Set(); 
        let offset = 0;
        let hasMore = true;

        try {
            while(hasMore) {
                const res = await fetch(`${API_URL}?limit=200&offset=${offset}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if(res.status === 429) { await new Promise(r => setTimeout(r, 4000)); continue; }
                if(!res.ok) throw new Error("Connection Failed");
                const data = await res.json();
                const items = data.items || [];
                
                if(items.length > 0) {
                    items.forEach(item => {
                        if (!taskIds.has(item.id)) {
                            STATE.allTasks.push(item);
                            taskIds.add(item.id);
                        }
                    });
                    
                    offset += 200;
                    document.getElementById('load-count').innerText = STATE.allTasks.length;
                    document.getElementById('progress-bar').style.width = '50%'; 
                    await new Promise(r => setTimeout(r, 10)); 
                } else { hasMore = false; }
            }

            localStorage.setItem('todoist_token', token);
            try { localStorage.setItem('todoist_task_cache', JSON.stringify(STATE.allTasks)); } catch(e) {}

            processData();
            calculateAndSendDeltas(STATE.allTasks);

            if(isResync) window.showToast("Stats updated!");

            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-dashboard').classList.remove('hidden');
            document.getElementById('loading-ui').classList.add('hidden');
            setTimeout(() => { document.getElementById('heatmap-scroll-area').scrollTop = document.getElementById('heatmap-scroll-area').scrollHeight; }, 100);

        } catch (e) {
            if(isResync) window.showToast("Sync failed: " + e.message);
            else document.getElementById('error-msg').innerText = e.message;
            document.getElementById('loading-ui').classList.add('hidden');
        } 
    }

    function calculateAndSendDeltas(currentTasks) {
        const lastStatsStr = localStorage.getItem('todoist_last_sync_stats');
        let lastStats = lastStatsStr ? JSON.parse(lastStatsStr) : { total: 0, hours: Array(24).fill(0), weekdays: Array(7).fill(0), months: {} };

        const currentStats = { total: currentTasks.length, hours: Array(24).fill(0), weekdays: Array(7).fill(0), months: {} };
        const uniqueDates = new Set();

        currentTasks.forEach(t => {
            const d = new Date(t.completed_at);
            currentStats.hours[d.getHours()]++;
            currentStats.weekdays[d.getDay()]++;
            const monthKey = t.completed_at.substring(0, 7); 
            currentStats.months[monthKey] = (currentStats.months[monthKey] || 0) + 1;
            uniqueDates.add(t.completed_at.substring(0, 10));
        });

        if (currentStats.total > lastStats.total) {
            const updates = {};
            const totalDelta = currentStats.total - lastStats.total;
            updates['global_stats/tasks_processed'] = increment(totalDelta);
            
            currentStats.hours.forEach((val, i) => {
                const diff = val - (lastStats.hours[i] || 0);
                if (diff > 0) updates[`global_stats/hours/${i}`] = increment(diff);
            });

            currentStats.weekdays.forEach((val, i) => {
                const diff = val - (lastStats.weekdays[i] || 0);
                if (diff > 0) updates[`global_stats/weekdays/${i}`] = increment(diff);
            });

            for (const [month, val] of Object.entries(currentStats.months)) {
                const diff = val - (lastStats.months[month] || 0);
                if (diff > 0) updates[`community_monthly/${month}`] = increment(diff);
            }

            update(ref(db), updates).catch(console.error);
        }
        localStorage.setItem('todoist_last_sync_stats', JSON.stringify(currentStats));
    }

    function renderFullHeatmap() {
        const container = document.getElementById('full-heatmap-content'); container.innerHTML = '';
        if(STATE.allTasks.length === 0) return;
        const dates = STATE.allTasks.map(t => new Date(t.completed_at));
        const minDate = new Date(Math.min(...dates)); const maxDate = new Date();
        let currentMonth = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
        const endMonth = new Date(maxDate.getFullYear(), maxDate.getMonth(), 1);
        while(currentMonth <= endMonth) {
            const year = currentMonth.getFullYear(); const month = currentMonth.getMonth();
            const monthLabel = currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const monthKey = `${year}-${String(month+1).padStart(2,'0')}`; 
            
            const monthWrapper = document.createElement('div'); monthWrapper.className = 'heatmap-month-wrapper';
            const labelEl = document.createElement('div'); labelEl.className = 'heatmap-month-label';
            if(STATE.filterType === 'MONTH' && STATE.filterValue === monthKey) labelEl.classList.add('selected');
            labelEl.innerText = monthLabel; labelEl.onclick = () => window.filterByMonth(monthKey);
            monthWrapper.appendChild(labelEl);
            const grid = document.createElement('div'); grid.className = 'calendar-grid';
            const daysInMonth = new Date(year, month + 1, 0).getDate(); const startDayIndex = new Date(year, month, 1).getDay();
            for(let i=0; i<startDayIndex; i++) { grid.appendChild(Object.assign(document.createElement('div'), {className:'cal-day empty'})); }
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const count = STATE.taskMap[dateStr] || 0;
                const dayEl = document.createElement('div'); let heat = 0;
                if(count>0) heat = count<=2?1 : count<=5?2 : count<=8?3 : count<=12?4 : 5;
                dayEl.className = `cal-day heat-${heat}`;
                if(STATE.filterType === 'DAY' && STATE.filterValue === dateStr) dayEl.classList.add('selected');
                dayEl.onclick = () => window.filterByDay(dateStr); dayEl.title = `${dateStr}: ${count} tasks`; dayEl.innerText = d;
                grid.appendChild(dayEl);
            }
            monthWrapper.appendChild(grid); container.appendChild(monthWrapper); currentMonth.setMonth(currentMonth.getMonth() + 1);
        }
    }

    function processData() {
        STATE.taskMap = {};
        STATE.allTasks.forEach(t => { 
            const localDate = getLocalISODate(t.completed_at);
            STATE.taskMap[localDate] = (STATE.taskMap[localDate] || 0) + 1; 
        });
        renderFullHeatmap(); window.resetFilter();
    }

    window.resetFilter = function() { window.setFilter('ALL', null); }
    window.filterByMonth = function(monthStr) { if(STATE.filterType === 'MONTH' && STATE.filterValue === monthStr) window.resetFilter(); else window.setFilter('MONTH', monthStr); }
    window.filterByDay = function(dateStr) { if(STATE.filterType === 'DAY' && STATE.filterValue === dateStr) window.resetFilter(); else window.setFilter('DAY', dateStr); }

    window.setFilter = function(type, value) {
        STATE.filterType = type; STATE.filterValue = value;
        if (type === 'ALL') { STATE.filteredTasks = [...STATE.allTasks]; document.getElementById('filter-badge').innerText = "All Time History"; document.getElementById('btn-reset').classList.add('hidden'); }
        else if (type === 'MONTH') { 
            STATE.filteredTasks = STATE.allTasks.filter(t => getLocalISODate(t.completed_at).startsWith(value)); 
            document.getElementById('filter-badge').innerText = value; document.getElementById('btn-reset').classList.remove('hidden'); 
        }
        else if (type === 'DAY') { 
            STATE.filteredTasks = STATE.allTasks.filter(t => getLocalISODate(t.completed_at) === value); 
            document.getElementById('filter-badge').innerText = value; document.getElementById('btn-reset').classList.remove('hidden'); 
        }
        updateStats(); renderFullHeatmap(); renderCharts();
    }

    function updateStats() {
        const tasks = STATE.filteredTasks; document.getElementById('stat-count').innerText = tasks.length.toLocaleString();
        let divisor = 1; if(STATE.filterType === 'ALL' || STATE.filterType === 'MONTH') { const dates = new Set(tasks.map(t=>getLocalISODate(t.completed_at))); divisor = dates.size || 1; }
        document.getElementById('stat-avg').innerText = (tasks.length / divisor).toFixed(1);
        const hourMap = {}; const dayMap = [0,0,0,0,0,0,0];
        tasks.forEach(t => { const d = new Date(t.completed_at); hourMap[d.getHours()] = (hourMap[d.getHours()] || 0) + 1; dayMap[d.getDay()]++; });
        const bestHour = Object.keys(hourMap).reduce((a, b) => hourMap[a] > hourMap[b] ? a : b, -1);
        const bestDayIndex = dayMap.indexOf(Math.max(...dayMap));
        const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        document.getElementById('stat-best-hour').innerText = bestHour >= 0 ? `${bestHour}:00` : '-';
        document.getElementById('stat-best-day').innerText = bestDayIndex >= 0 ? days[bestDayIndex] : '-';
    }

    function renderCharts() {
        const timelineLabels = []; const timelineData = []; const weekData = [0,0,0,0,0,0,0]; const hourData = new Array(24).fill(0); const aggMap = {};
        STATE.filteredTasks.forEach(t => {
            const d = new Date(t.completed_at); weekData[d.getDay()]++; hourData[d.getHours()]++;
            let key;
            if (STATE.filterType === 'ALL') { key = getLocalISODate(t.completed_at).substring(0, 7); document.getElementById('chart-title-timeline').innerText = "History by Month"; }
            else { key = STATE.filterType === 'MONTH' ? getLocalISODate(t.completed_at) : d.getHours() + ":00"; document.getElementById('chart-title-timeline').innerText = STATE.filterType === 'MONTH' ? "Daily Breakdown" : "Hourly Breakdown"; }
            aggMap[key] = (aggMap[key] || 0) + 1;
        });
        Object.keys(aggMap).sort().forEach(k => { timelineLabels.push(k); timelineData.push(aggMap[k]); });
        drawChart('chart-timeline', 'bar', timelineLabels, timelineData);
        drawChart('chart-week', 'bar', ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'], weekData);
        drawChart('chart-hours', 'line', [...Array(24).keys()].map(x=>x), hourData);
    }

    function drawChart(id, type, labels, data) {
        const ctx = document.getElementById(id).getContext('2d');
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        const textColor = isDark ? '#bdc3c7' : '#2c3e50';
        const gridColor = isDark ? '#404040' : '#eaeaea';
        if(STATE.charts[id]) STATE.charts[id].destroy();
        STATE.charts[id] = new Chart(ctx, {
            type: type, data: { labels: labels, datasets: [{ data: data, backgroundColor: '#e44232', borderColor: '#e44232', borderWidth: 1, tension: 0.3, fill: type === 'line' }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: textColor }, grid: { display: false } }, y: { beginAtZero: true, ticks: { color: textColor }, grid: { color: gridColor } } } }
        });
    }

    window.openCommunityModal = function() { document.getElementById('community-modal').classList.remove('hidden'); }
    window.closeCommunityModal = function() { document.getElementById('community-modal').classList.add('hidden'); }
    window.exportHeatmap = function() {
        const element = document.getElementById('full-heatmap-content'); const originalBg = element.style.backgroundColor; const theme = localStorage.getItem('theme');
        element.style.backgroundColor = theme === 'dark' ? '#2d2d2d' : '#ffffff'; element.style.padding = '20px';
        html2canvas(element).then(canvas => {
            const link = document.createElement('a'); link.download = `todoist-heatmap-history-${Date.now()}.png`; link.href = canvas.toDataURL(); link.click();
            element.style.backgroundColor = originalBg; element.style.padding = '0';
            update(statsRef, { exports: increment(1) });
        });
    }
    window.exportChart = function(chartId) {
        const chart = STATE.charts[chartId]; if(!chart) return;
        const link = document.createElement('a'); link.download = `todoist-${chartId}-${Date.now()}.png`; link.href = chart.toBase64Image(); link.click();
        update(statsRef, { exports: increment(1) });
    }
    window.resyncData = function() { window.initFetch(true); }
    window.logout = function() { 
        localStorage.removeItem('todoist_token'); 
        localStorage.removeItem('todoist_task_cache'); 
        localStorage.removeItem('todoist_last_sync_stats'); 
        location.reload(); 
    }
</script>
</body>
</html>
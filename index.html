<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todoist Analytics Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect x='8' y='8' width='112' height='112' rx='28' fill='%23e44232'/%3E%3Cpath d='M36 68 L58 90 L94 38' stroke='white' stroke-width='14' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3Ccircle cx='94' cy='38' r='9' fill='white'/%3E%3C/svg%3E">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --bg-color:#f4f6f8; --card-bg:#ffffff; --text-main:#2c3e50; --text-muted:#7f8c8d; --primary:#e44232; --primary-hover:#c0392b; --border:#e1e8ed; --highlight:#ffe0dd; --selected-border:#e44232; --modal-overlay:rgba(0,0,0,0.5); }
        [data-theme="dark"] { --bg-color:#1a1a1a; --card-bg:#2d2d2d; --text-main:#ecf0f1; --text-muted:#bdc3c7; --primary:#ff6b6b; --primary-hover:#ff5252; --border:#404040; --highlight:#3d3d3d; --selected-border:#ff6b6b; --modal-overlay:rgba(0,0,0,0.8); }
        body { margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; background-color:var(--bg-color); color:var(--text-main); transition:background 0.3s,color 0.3s; padding-bottom:70px; }
        .container { max-width:1200px; margin:0 auto; padding:20px; }
        .hidden { display:none!important; }
        .flex { display:flex; align-items:center; }
        .between { justify-content:space-between; }
        .gap-10 { gap:10px; }
        .btn { padding:8px 16px; border-radius:6px; border:none; cursor:pointer; font-size:14px; font-weight:600; transition:0.2s; display:inline-flex; align-items:center; gap:8px; text-decoration:none; }
        .btn-sm { padding:4px 10px; font-size:12px; }
        .btn-primary { background:var(--primary); color:white; }
        .btn-primary:hover { background:var(--primary-hover); }
        .btn-outline { background:transparent; border:1px solid var(--border); color:var(--text-main); }
        .btn-outline:hover { background:var(--border); }
        .card { background:var(--card-bg); border-radius:12px; padding:20px; box-shadow:0 4px 6px rgba(0,0,0,0.05); margin-bottom:20px; border:1px solid var(--border); }
        .heatmap-container { max-height:400px; overflow-y:auto; border:1px solid var(--border); border-radius:8px; padding:10px; background:var(--card-bg); scrollbar-width:thin; scrollbar-color:var(--text-muted) transparent; }
        .heatmap-container::-webkit-scrollbar { width:6px; }
        .heatmap-container::-webkit-scrollbar-thumb { background-color:var(--text-muted); border-radius:3px; }
        .heatmap-month-wrapper { margin-bottom:15px; }
        .heatmap-month-label { font-size:13px; font-weight:bold; margin-bottom:5px; color:var(--text-muted); cursor:pointer; display:inline-block; transition:0.2s; padding:2px 8px; border-radius:4px; }
        .heatmap-month-label:hover { color:var(--primary); background:var(--highlight); }
        .heatmap-month-label.selected { color:white; background:var(--primary); }
        .calendar-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; }
        .cal-day { aspect-ratio:1; border-radius:4px; display:flex; justify-content:center; align-items:center; cursor:pointer; border:1px solid transparent; position:relative; font-size:10px; font-weight:bold; color:var(--text-main); }
        .cal-day:hover { border-color:var(--text-muted); transform:scale(1.1); z-index:2; }
        .cal-day.selected { border:2px solid var(--selected-border); transform:scale(1.1); z-index:3; }
        .cal-day.empty { background:transparent; cursor:default; pointer-events:none; }
        .heat-0 { background:var(--bg-color); color:var(--text-muted); opacity:0.5; }
        .heat-1 { background:rgba(228,66,50,0.15); }
        .heat-2 { background:rgba(228,66,50,0.35); }
        .heat-3 { background:rgba(228,66,50,0.55); color:white; }
        .heat-4 { background:rgba(228,66,50,0.75); color:white; }
        .heat-5 { background:#e44232; color:white; }
        .dashboard-grid { display:grid; grid-template-columns:350px 1fr; gap:20px; }
        @media (max-width:900px) { .dashboard-grid { grid-template-columns:1fr; } }
        .stat-tiles { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px; }
        .stat-tile { background:var(--card-bg); padding:15px; border-radius:8px; border:1px solid var(--border); text-align:center; }
        .stat-num { font-size:24px; font-weight:800; color:var(--text-main); }
        .stat-lbl { font-size:11px; text-transform:uppercase; color:var(--text-muted); font-weight:700; margin-top:5px; }
        .chart-container { position:relative; height:250px; width:100%; }
        .login-box { max-width:500px; margin:80px auto; text-align:center; }
        input[type="password"] { width:100%; padding:12px; border:1px solid var(--border); background:var(--card-bg); color:var(--text-main); border-radius:6px; margin-bottom:15px; box-sizing:border-box; }
        .progress-track { height:6px; background:var(--border); border-radius:3px; overflow:hidden; margin-top:10px; }
        .progress-fill { height:100%; background:var(--primary); width:0%; transition:width 0.3s; }
        .community-bar { position:fixed; bottom:0; left:0; width:100%; background:var(--card-bg); border-top:1px solid var(--border); padding:10px 20px; font-size:12px; color:var(--text-muted); display:flex; justify-content:center; gap:20px; box-shadow:0 -2px 10px rgba(0,0,0,0.05); z-index:100; cursor:pointer; transition:background 0.2s; }
        .community-bar:hover { background:var(--border); }
        .comm-stat strong { color:var(--primary); font-size:14px; margin-left:4px; }
        .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:var(--modal-overlay); z-index:2000; display:flex; justify-content:center; align-items:center; }
        .modal-content { background:var(--card-bg); width:95%; max-width:800px; border-radius:12px; padding:25px; box-shadow:0 10px 25px rgba(0,0,0,0.2); position:relative; max-height: 90vh; overflow-y: auto; }
        #toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(20px); background:#333; color:white; padding:12px 24px; border-radius:30px; font-weight:600; box-shadow:0 5px 15px rgba(0,0,0,0.2); opacity:0; pointer-events:none; transition:opacity 0.3s, transform 0.3s; z-index:3000; }
        #toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
        .task-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
        .task-item:last-child { border-bottom: none; }
        .task-content { flex: 1; margin-right: 15px; line-height: 1.4; }
        .task-project { font-size: 10px; background: var(--highlight); color: var(--primary); padding: 3px 8px; border-radius: 4px; font-weight: bold; white-space: nowrap; }
        
        .proj-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 13px; }
        .proj-color { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }
        .proj-name { width: 40%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 10px; }
        .proj-bar-track { flex: 1; height: 6px; background: var(--border); border-radius: 3px; margin-right: 10px; overflow: hidden; }
        .proj-bar-fill { height: 100%; }
        .proj-count { font-weight: bold; width: 30px; text-align: right; }

        select.btn-outline { -webkit-appearance: none; -moz-appearance: none; appearance: none; padding-right: 30px; background-color: var(--card-bg); }
        select.btn-outline option { background-color: var(--card-bg); color: var(--text-main); }
        
        .export-option-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; border: 2px solid var(--border); border-radius: 12px; cursor: pointer; transition: all 0.2s; background: var(--card-bg); color: var(--text-main); text-decoration: none; width: 120px; height: 120px; margin: 10px; }
        .export-option-btn:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .export-option-btn i { font-size: 32px; margin-bottom: 10px; color: var(--primary); }
        .export-option-btn span { font-weight: bold; font-size: 14px; }
    </style>
</head>
<body>

<div id="toast"></div>

<div id="export-modal" class="modal-overlay hidden">
    <div class="modal-content" style="max-width: 600px; text-align: center;">
        <div class="flex between" style="margin-bottom: 20px;">
            <h2 style="margin:0; color: var(--primary);">Export Report</h2>
            <button onclick="window.closeExportModal()" class="btn btn-outline btn-sm"><i class="fa-solid fa-times"></i></button>
        </div>
        <p style="color: var(--text-muted); margin-bottom: 30px;">Choose a format for your analytics report.</p>
        <div class="flex" style="justify-content: center; flex-wrap: wrap;">
            <button class="export-option-btn" onclick="window.exportTextReport()">
                <i class="fa-solid fa-file-alt"></i>
                <span>Text File (.txt)</span>
            </button>
            <button class="export-option-btn" onclick="window.exportPdfReport()">
                <i class="fa-solid fa-file-pdf"></i>
                <span>Visual PDF (.pdf)</span>
            </button>
            <button class="export-option-btn" onclick="window.exportCsvReport()">
                <i class="fa-solid fa-file-csv"></i>
                <span>CSV Data (.csv)</span>
            </button>
        </div>
    </div>
</div>

<div class="community-bar" onclick="window.openCommunityModal()">
    <div class="comm-stat">Tasks: <strong id="global-tasks">...</strong></div>
    <div class="comm-stat">Projects: <strong id="global-projects">...</strong></div>
    <div class="comm-stat">Wrappeds: <strong id="global-wrappeds">...</strong></div>
    <div class="comm-stat">Syncs: <strong id="global-syncs">...</strong></div>
    <div class="comm-stat">Reports: <strong id="global-reports">...</strong></div>
</div>

<div id="community-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="flex between" style="margin-bottom: 20px;">
            <h2 style="margin:0; color: var(--primary);">Community Stats</h2>
            <button onclick="window.closeCommunityModal()" class="btn btn-outline btn-sm"><i class="fa-solid fa-times"></i></button>
        </div>
        <div class="stat-tiles" style="grid-template-columns: repeat(3, 1fr);">
            <div class="stat-tile"><div class="stat-num" id="comm-total">...</div><div class="stat-lbl">Tasks</div></div>
            <div class="stat-tile"><div class="stat-num" id="comm-projects">...</div><div class="stat-lbl">Projects</div></div>
            <div class="stat-tile"><div class="stat-num" id="comm-avg">...</div><div class="stat-lbl">Daily Avg</div></div>
        </div>
        <div class="card" style="margin-top:20px;">
            <h3 style="margin-top:0; font-size:14px; color:var(--text-muted); text-transform:uppercase;">Global Activity</h3>
            <div class="chart-container" style="height:180px;"><canvas id="comm-chart"></canvas></div>
        </div>
    </div>
</div>

<div id="view-login" class="container login-box">
    <div class="card">
        <h1><i class="fa-solid fa-layer-group"></i> Todoist Analytics</h1>
        <p style="color: var(--text-muted);">Visualize your productivity history.</p>
        <input type="password" id="api-token" placeholder="Paste API Token">
        <button onclick="window.initFetch()" class="btn btn-primary" style="width: 100%; justify-content: center;">Load Data</button>
        <div id="loading-ui" class="hidden" style="margin-top: 20px;">
            <div class="flex between" style="font-size: 12px;"><span id="loading-msg">Fetching history...</span><span id="load-count">0</span></div>
            <div class="progress-track"><div id="progress-bar" class="progress-fill"></div></div>
            <div id="error-msg" style="color: red; font-size: 12px; margin-top: 10px;"></div>
        </div>
    </div>
</div>

<div id="view-dashboard" class="container hidden">
    <div class="flex between" style="margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px;">
        <div class="flex gap-10">
            <h2 style="margin:0; color: var(--primary);">Analytics</h2>
            <select id="project-filter" onchange="window.filterByProject(this.value)" class="btn btn-outline btn-sm" style="max-width: 150px; font-weight: normal;">
                <option value="ALL">All Projects</option>
            </select>
            
            <div id="filter-badge" style="background: var(--text-main); color: var(--bg-color); padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold;">All Time</div>
            <button id="btn-reset" onclick="window.resetFilter()" class="hidden btn btn-outline btn-sm"><i class="fa-solid fa-times"></i> Clear</button>
        </div>
        <div class="flex gap-10">
            <button onclick="window.openExportModal()" class="btn btn-outline btn-sm"><i class="fa-solid fa-file-export"></i> Export</button>
            <a href="wrapped.html" class="btn btn-primary btn-sm"><i class="fa-solid fa-gift"></i> Wrapped</a>
            <a href="about.html" class="btn btn-outline btn-sm"><i class="fa-solid fa-info-circle"></i> About</a>
            <button onclick="window.toggleTheme()" class="btn btn-outline btn-sm"><i id="theme-icon" class="fa-solid fa-moon"></i></button>
            <button onclick="window.resyncData()" class="btn btn-outline btn-sm"><i class="fa-solid fa-rotate"></i></button>
            <button onclick="window.logout()" class="btn btn-outline btn-sm"><i class="fa-solid fa-sign-out-alt"></i></button>
        </div>
    </div>

    <div class="dashboard-grid">
        <div>
            <div class="card">
                <h3 style="margin:0; font-size:16px; margin-bottom:10px;">History Heatmap</h3>
                <div id="heatmap-scroll-area" class="heatmap-container"><div id="full-heatmap-content"></div></div>
            </div>
            <div class="stat-tiles">
                <div class="stat-tile"><div class="stat-num" id="stat-count">0</div><div class="stat-lbl">Tasks</div></div>
                <div class="stat-tile"><div class="stat-num" id="stat-avg">0</div><div class="stat-lbl">Daily Avg</div></div>
            </div>
        </div>
        <div>
            <div class="card">
                <h3 id="chart-title-timeline" style="margin:0; font-size:16px;">Activity Timeline</h3>
                <div class="chart-container"><canvas id="chart-timeline"></canvas></div>
            </div>
            
            <div id="project-breakdown-card" class="card">
                <h3 style="margin:0; font-size:16px; margin-bottom:15px; color:var(--primary);">Project Breakdown</h3>
                <div id="project-breakdown-list" style="max-height: 250px; overflow-y: auto; padding-right: 5px;"></div>
            </div>

            <div id="label-breakdown-card" class="card">
                <h3 style="margin:0; font-size:16px; margin-bottom:15px; color:var(--primary);">Tag Breakdown</h3>
                <div id="label-breakdown-list" style="max-height: 250px; overflow-y: auto; padding-right: 5px;"></div>
            </div>

            <div id="tasks-detail-card" class="card hidden">
                <div class="flex between" style="margin-bottom:15px;">
                    <h3 id="tasks-detail-title" style="margin:0; font-size:16px; color:var(--primary);">Daily Tasks</h3>
                    <span id="tasks-count-badge" style="font-size:11px; background:var(--border); padding:2px 8px; border-radius:10px;">0 tasks</span>
                </div>
                <div id="tasks-list" style="max-height: 500px; overflow-y: auto; padding-right:5px;"></div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, update, increment, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCtr9BAKgKj4eHqk5lCaDlrASZubFncYqA",
        authDomain: "todoist-stats-cd36f.firebaseapp.com",
        databaseURL: "https://todoist-stats-cd36f-default-rtdb.firebaseio.com",
        projectId: "todoist-stats-cd36f",
        storageBucket: "todoist-stats-cd36f.firebasestorage.app",
        messagingSenderId: "836832717528",
        appId: "1:836832717528:web:e01ff49d10969d429e05ad"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const API_URL = 'https://api.todoist.com/sync/v9/completed/get_all';
    
    const TODOIST_COLORS = {
        "berry_red": "#b8256f", "red": "#db4035", "orange": "#ff9933",
        "yellow": "#fad000", "olive_green": "#afb83b", "lime_green": "#7ecc49",
        "green": "#299438", "mint_green": "#6accbc", "teal": "#158fad",
        "sky_blue": "#14aaf5", "light_blue": "#96c3eb", "blue": "#4073ff",
        "grape": "#884dff", "violet": "#af38eb", "lavender": "#eb96eb",
        "magenta": "#e05194", "salmon": "#ff8d85", "charcoal": "#808080",
        "grey": "#b8b8b8", "taupe": "#ccac93"
    };

    let STATE = {
        allTasks: [], activeTasks: [], filteredTasks: [], taskMap: {}, projectMap: {}, projectColorMap: {},
        labelMap: {}, labelColorMap: {}, charts: {}, filterType: 'ALL', filterValue: null, 
        isAuthReady: false, isCalculatingDeltas: false, isFetching: false, selectedProject: 'ALL'
    };

    onValue(ref(db, 'global_stats'), (snapshot) => {
        const data = snapshot.val(); if (!data) return;
        document.getElementById('global-tasks').innerText = (data.tasks_processed || 0).toLocaleString();
        document.getElementById('global-projects').innerText = (data.projects_processed || 0).toLocaleString();
        document.getElementById('global-wrappeds').innerText = (data.wrappeds_generated || 0).toLocaleString();
        document.getElementById('global-syncs').innerText = (data.syncs_performed || 0).toLocaleString();
        document.getElementById('global-reports').innerText = (data.reports_exported || 0).toLocaleString();
        document.getElementById('comm-total').innerText = (data.tasks_processed || 0).toLocaleString();
        document.getElementById('comm-projects').innerText = (data.projects_processed || 0).toLocaleString();
        const totalDays = data.total_days_logged || 1;
        document.getElementById('comm-avg').innerText = (data.tasks_processed / totalDays).toFixed(1);
    });

    onValue(ref(db, 'community_monthly'), (snapshot) => {
        const data = snapshot.val(); if (!data) return;
        const keys = Object.keys(data).sort();
        drawCommunityChart('comm-chart', keys, keys.map(k => data[k]));
    });

    onAuthStateChanged(auth, (user) => {
        if (user) {
            STATE.isAuthReady = true;
            const token = localStorage.getItem('todoist_token');
            if (token) {
                document.getElementById('api-token').value = token;
                window.initFetch();
            }
        } else { signInAnonymously(auth).catch(console.error); }
    });

    window.onload = () => {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) { if (savedTheme === 'dark') window.applyTheme('dark'); }
        else { if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) window.applyTheme('dark'); }
        
        const projCache = localStorage.getItem('todoist_projects_cache');
        if (projCache) STATE.projectMap = JSON.parse(projCache);
        const colorCache = localStorage.getItem('todoist_colors_cache');
        if (colorCache) STATE.projectColorMap = JSON.parse(colorCache);
        const labelCache = localStorage.getItem('todoist_labels_cache');
        if (labelCache) STATE.labelMap = JSON.parse(labelCache);
        const labelColorCache = localStorage.getItem('todoist_label_colors_cache');
        if (labelColorCache) STATE.labelColorMap = JSON.parse(labelColorCache);
    };

    function getLocalISODate(isoString) {
        const d = new Date(isoString);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function getProjectColor(pid, name) {
        const realColor = STATE.projectColorMap[pid];
        if (realColor && TODOIST_COLORS[realColor]) return TODOIST_COLORS[realColor];
        return generateColorHash(name);
    }
    function getLabelColor(lid, name) {
        const realColor = STATE.labelColorMap[lid];
        if (realColor && TODOIST_COLORS[realColor]) return TODOIST_COLORS[realColor];
        return generateColorHash(name);
    }
    function generateColorHash(name) {
        let hash = 0; const str = name || "Unknown";
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        const h = Math.abs(hash % 360);
        return `hsl(${h}, 65%, 55%)`; 
    }
    function extractTagsFromContent(content) {
        const regex = /@([a-zA-Z0-9_]+)/g;
        const matches = content.match(regex);
        return matches ? matches.map(m => m.substring(1)) : [];
    }

    window.openExportModal = () => document.getElementById('export-modal').classList.remove('hidden');
    window.closeExportModal = () => document.getElementById('export-modal').classList.add('hidden');

    window.exportCsvReport = function() {
        // Track export
        update(ref(db, 'global_stats'), { reports_exported: increment(1) }).catch(console.error);

        const filter = STATE.filterType === 'ALL' ? 'All Time' : STATE.filterValue;
        const tasks = STATE.filteredTasks;
        
        let csvContent = "Date,Time,Project,Task,Tags\n";

        tasks.forEach(t => {
            const dateObj = new Date(t.completed_at);
            const date = dateObj.toLocaleDateString();
            const time = dateObj.toLocaleTimeString();
            
            const proj = (STATE.projectMap[t.project_id] || "Deleted Project").replace(/"/g, '""');
            const content = t.content.replace(/"/g, '""');
            
            let tags = (t.labels || []).map(l => STATE.labelMap[l] || "");
            const textTags = extractTagsFromContent(t.content);
            tags = [...tags, ...textTags];
            const tagStr = tags.join("; ").replace(/"/g, '""');

            csvContent += `"${date}","${time}","${proj}","${content}","${tagStr}"\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `todoist-data-${filter}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.closeExportModal();
    }

    window.exportTextReport = function() {
        // Track export
        update(ref(db, 'global_stats'), { reports_exported: increment(1) }).catch(console.error);

        const projName = STATE.selectedProject === 'ALL' ? 'All Projects' : (STATE.projectMap[STATE.selectedProject] || 'Unknown Project');
        const filter = STATE.filterType === 'ALL' ? 'All Time' : STATE.filterValue;
        const count = STATE.filteredTasks.length;
        const days = new Set(STATE.filteredTasks.map(t => getLocalISODate(t.completed_at))).size || 1;
        const avg = (count / days).toFixed(1);

        let report = `TODOIST ANALYTICS REPORT\n`;
        report += `Generated: ${new Date().toLocaleString()}\n\n`;
        report += `SCOPE\nProject: ${projName}\nPeriod: ${filter}\n\n`;
        report += `STATS\nTotal Completed: ${count}\nActive Days: ${days}\nDaily Average: ${avg}\n\n`;

        const tagCounts = {};
        STATE.filteredTasks.forEach(t => {
            (t.labels || []).forEach(l => { const n = STATE.labelMap[l]; if(n) tagCounts[n] = (tagCounts[n]||0)+1; });
            const textTags = extractTagsFromContent(t.content);
            textTags.forEach(n => tagCounts[n] = (tagCounts[n]||0)+1);
        });
        const sortedTags = Object.entries(tagCounts).sort((a,b)=>b[1]-a[1]);
        if(sortedTags.length > 0) {
            report += `TOP TAGS\n`;
            sortedTags.forEach(([tag, c]) => report += `- ${tag}: ${c}\n`);
            report += `\n`;
        }

        if(STATE.filterType === 'DAY' || count <= 50) {
            report += `TASK LIST\n`;
            const sorted = [...STATE.filteredTasks].sort((a,b) => new Date(a.completed_at) - new Date(b.completed_at));
            sorted.forEach(t => {
                const date = t.completed_at.substring(0,10);
                const time = new Date(t.completed_at).toLocaleTimeString();
                report += `[${date} ${time}] ${t.content}\n`;
            });
        } else {
            report += `Task list omitted (Total: ${count}). Filter by day to see details.\n`;
        }

        const blob = new Blob([report], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `todoist-report-${filter}.txt`;
        a.click();
        URL.revokeObjectURL(url);
        window.closeExportModal();
    }

    // PDF Export (Multi-page supported)
    window.exportPdfReport = function() {
        // Track export
        update(ref(db, 'global_stats'), { reports_exported: increment(1) }).catch(console.error);

        window.closeExportModal();
        
        const reportDiv = document.createElement('div');
        reportDiv.style.width = '800px';
        reportDiv.style.padding = '40px';
        reportDiv.style.background = '#ffffff';
        reportDiv.style.color = '#333';
        reportDiv.style.position = 'absolute';
        reportDiv.style.top = '-9999px';
        reportDiv.style.left = '-9999px';
        reportDiv.style.fontFamily = 'sans-serif';

        const projName = STATE.selectedProject === 'ALL' ? 'All Projects' : (STATE.projectMap[STATE.selectedProject] || 'Unknown Project');
        const filter = STATE.filterType === 'ALL' ? 'All Time' : STATE.filterValue;
        const count = STATE.filteredTasks.length;
        const days = new Set(STATE.filteredTasks.map(t => getLocalISODate(t.completed_at))).size || 1;
        const avg = (count / days).toFixed(1);

        function generateFullList(countMap, map, colorFunc, title) {
            let aggregatedMap = {};
            let deletedCount = 0;
            Object.entries(countMap).forEach(([id, c]) => {
                const name = map[id] || (title === 'Project' ? 'Deleted Projects' : id);
                if (title === 'Project' && name === 'Deleted Projects') { deletedCount += c; } 
                else { aggregatedMap[name] = { count: c, id: id }; }
            });

            let sorted = Object.entries(aggregatedMap).map(([name, obj]) => ({ name: name, count: obj.count, id: obj.id }));
            if (deletedCount > 0) sorted.push({ name: 'Deleted Projects', count: deletedCount, id: 'deleted' });
            sorted.sort((a,b) => b.count - a.count);

            const maxVal = sorted[0] ? sorted[0].count : 1;
            let html = '';
            sorted.forEach(item => {
                const color = colorFunc(item.id, item.name);
                const percent = (item.count / maxVal) * 100;
                html += `
                    <div style="display: flex; align-items: center; margin-bottom: 8px; font-size: 11px;">
                        <div style="width: 8px; height: 8px; border-radius: 50%; margin-right: 10px; background:${color}; flex-shrink:0;"></div>
                        <div style="flex: 0 0 200px; margin-right: 15px; white-space: normal; line-height: 1.2;">${item.name}</div>
                        <div style="flex: 1; height: 6px; background: #eee; border-radius: 3px; margin-right: 15px; overflow: hidden; align-self: center;">
                            <div style="height: 100%; width:${percent}%; background:${color};"></div>
                        </div>
                        <div style="font-weight: bold; width: 30px; text-align: right; align-self: center;">${item.count}</div>
                    </div>
                `;
            });
            return html || '<div style="color:#999; font-size:12px;">No data.</div>';
        }

        const pCounts = {}; const tCounts = {};
        STATE.filteredTasks.forEach(t => {
            const pid = t.project_id || 'unknown';
            pCounts[pid] = (pCounts[pid] || 0) + 1;
            (t.labels || []).forEach(l => { const n = STATE.labelMap[l]; if(n) tCounts[l] = (tCounts[l]||0)+1; });
            const textTags = extractTagsFromContent(t.content);
            textTags.forEach(n => { tCounts[n] = (tCounts[n]||0)+1; });
        });

        const projHtml = generateFullList(pCounts, STATE.projectMap, getProjectColor, 'Project');
        const labelMapWrapper = new Proxy(STATE.labelMap, { get: (target, prop) => target[prop] || prop });
        const tagHtml = generateFullList(tCounts, labelMapWrapper, getLabelColor, 'Tag');

        let html = `
            <div style="border-bottom: 2px solid #e44232; padding-bottom: 20px; margin-bottom: 30px;">
                <h1 style="color:#e44232; margin:0;">Todoist Analytics Report</h1>
                <p style="margin:5px 0 0 0; color:#666;">Generated on ${new Date().toLocaleDateString()}</p>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                <div style="background:#f9f9f9; padding:15px; border-radius:8px;">
                    <div style="font-weight:bold; color:#666; font-size:12px; text-transform:uppercase;">Scope</div>
                    <div style="font-size:16px;">${projName} â€¢ ${filter}</div>
                </div>
                <div style="background:#f9f9f9; padding:15px; border-radius:8px; display:flex; justify-content:space-around;">
                    <div style="text-align:center;">
                        <div style="font-weight:bold; font-size:20px; color:#e44232;">${count}</div>
                        <div style="font-size:10px; color:#666;">TASKS</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-weight:bold; font-size:20px; color:#333;">${avg}</div>
                        <div style="font-size:10px; color:#666;">DAILY AVG</div>
                    </div>
                </div>
            </div>
        `;

        const liveCanvas = document.getElementById('chart-timeline');
        if(liveCanvas) {
            html += `
                <div style="margin-bottom: 30px; border:1px solid #eee; padding:20px; border-radius:8px;">
                    <h3 style="margin-top:0;">Activity Timeline</h3>
                    <img src="${liveCanvas.toDataURL()}" style="width:100%; height:auto;" />
                </div>
            `;
        }

        html += `
            <div style="margin-bottom: 40px;">
                <h3 style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:5px;">All Projects</h3>
                ${projHtml}
            </div>
            <div style="margin-bottom: 40px;">
                <h3 style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:5px;">All Tags</h3>
                ${tagHtml}
            </div>
        `;

        reportDiv.innerHTML = html;
        document.body.appendChild(reportDiv);

        html2canvas(reportDiv, { scale: 2 }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = pageWidth;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            const totalPages = Math.ceil(imgHeight / pageHeight);
            
            pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
            
            for (let i = 1; i < totalPages; i++) {
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, -(pageHeight * i), imgWidth, imgHeight);
            }

            pdf.save(`todoist-report-${filter}.pdf`);
            document.body.removeChild(reportDiv);
        });
    }

    window.initFetch = async function(resync = false) {
        if (STATE.isFetching) return;
        STATE.isFetching = true;

        const token = document.getElementById('api-token').value.trim();
        if (!token) { STATE.isFetching = false; return; }

        if (!resync) {
            const cached = localStorage.getItem('todoist_task_cache');
            if (cached) {
                STATE.allTasks = JSON.parse(cached);
                STATE.activeTasks = [...STATE.allTasks];
                populateProjectFilter();
                processData();
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('view-dashboard').classList.remove('hidden');
                if(STATE.isAuthReady) calculateDeltas();
                else setTimeout(() => { if(STATE.isAuthReady) calculateDeltas(); }, 2000);
                STATE.isFetching = false;
                return;
            }
        }

        document.getElementById('loading-ui').classList.remove('hidden');
        STATE.allTasks = [];
        let offset = 0, hasMore = true;

        try {
            const projRes = await fetch('https://api.todoist.com/sync/v9/sync', {
                method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ sync_token: '*', resource_types: ['projects', 'labels'] })
            });
            const projData = await projRes.json();
            
            if (projData.projects) {
                projData.projects.forEach(p => {
                    STATE.projectMap[p.id] = p.name;
                    STATE.projectColorMap[p.id] = p.color; 
                });
                localStorage.setItem('todoist_projects_cache', JSON.stringify(STATE.projectMap));
                localStorage.setItem('todoist_colors_cache', JSON.stringify(STATE.projectColorMap));
            }

            if (projData.labels) {
                projData.labels.forEach(l => {
                    STATE.labelMap[l.id] = l.name;
                    STATE.labelColorMap[l.id] = l.color;
                });
                localStorage.setItem('todoist_labels_cache', JSON.stringify(STATE.labelMap));
                localStorage.setItem('todoist_label_colors_cache', JSON.stringify(STATE.labelColorMap));
            }

            while(hasMore) {
                const res = await fetch(`${API_URL}?limit=200&offset=${offset}&annotate_items=true`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if(data.items.length > 0) {
                    STATE.allTasks = STATE.allTasks.concat(data.items);
                    offset += 200;
                    document.getElementById('load-count').innerText = STATE.allTasks.length;
                } else { hasMore = false; }
            }

            localStorage.setItem('todoist_token', token);
            localStorage.setItem('todoist_task_cache', JSON.stringify(STATE.allTasks));
            
            STATE.activeTasks = [...STATE.allTasks];
            populateProjectFilter();
            processData();
            
            if (STATE.isAuthReady) calculateDeltas();
            else setTimeout(() => calculateDeltas(), 1000);

            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-dashboard').classList.remove('hidden');
        } catch (e) { alert("Fetch failed: " + e.message); }
        finally {
            STATE.isFetching = false; 
            document.getElementById('loading-ui').classList.add('hidden');
            document.getElementById('loading-msg').innerText = "Fetching history...";
        }
    }

    function calculateDeltas() {
        if (!STATE.isAuthReady || STATE.isCalculatingDeltas) return;
        STATE.isCalculatingDeltas = true; 

        const lastStr = localStorage.getItem('todoist_last_sync_stats');
        const last = lastStr ? JSON.parse(lastStr) : { tasks: 0, projects: 0, months: {} };
        const currentTasks = STATE.allTasks.length;
        const currentProjects = Object.keys(STATE.projectMap).length;
        
        const currentMonths = {};
        STATE.allTasks.forEach(t => {
            const m = getLocalISODate(t.completed_at).substring(0, 7);
            currentMonths[m] = (currentMonths[m] || 0) + 1;
        });

        localStorage.setItem('todoist_last_sync_stats', JSON.stringify({ 
            tasks: currentTasks, projects: currentProjects, months: currentMonths 
        }));

        const updates = {};
        let hasUpdates = false;

        updates['global_stats/syncs_performed'] = increment(1);
        hasUpdates = true;

        if (currentTasks > last.tasks) {
            updates['global_stats/tasks_processed'] = increment(currentTasks - last.tasks);
            hasUpdates = true;
        }
        if (currentProjects > last.projects) {
            updates['global_stats/projects_processed'] = increment(currentProjects - last.projects);
            hasUpdates = true;
        }
        for (const [month, count] of Object.entries(currentMonths)) {
            const lastCount = last.months && last.months[month] ? last.months[month] : 0;
            const diff = count - lastCount;
            if (diff > 0) {
                updates[`community_monthly/${month}`] = increment(diff);
                hasUpdates = true;
            }
        }
        if (hasUpdates) {
            update(ref(db), updates)
                .then(() => { console.log("Stats synced to community."); })
                .catch((e) => { console.error("Stats sync failed:", e); })
                .finally(() => { STATE.isCalculatingDeltas = false; });
        } else {
            STATE.isCalculatingDeltas = false;
        }
    }

    window.populateProjectFilter = function() {
        const sel = document.getElementById('project-filter');
        sel.innerHTML = '<option value="ALL">All Projects</option>';
        const sorted = Object.entries(STATE.projectMap).sort((a,b) => a[1].localeCompare(b[1]));
        sorted.forEach(([id, name]) => {
            const opt = document.createElement('option');
            opt.value = id;
            opt.innerText = name;
            sel.appendChild(opt);
        });
    }

    window.filterByProject = function(pid) {
        STATE.selectedProject = pid;
        if (pid === 'ALL') {
            STATE.activeTasks = [...STATE.allTasks];
        } else {
            STATE.activeTasks = STATE.allTasks.filter(t => t.project_id === pid);
        }
        processData();
    }

    function processData() {
        STATE.taskMap = {};
        STATE.activeTasks.forEach(t => {
            const d = getLocalISODate(t.completed_at);
            STATE.taskMap[d] = (STATE.taskMap[d] || 0) + 1;
        });
        renderHeatmap();
        window.setFilter('ALL', null);
        
        setTimeout(() => {
             const el = document.getElementById('heatmap-scroll-area');
             if(el) el.scrollTop = el.scrollHeight;
        }, 100);
    }

    function renderHeatmap() {
        const container = document.getElementById('full-heatmap-content');
        container.innerHTML = '';
        
        if (STATE.activeTasks.length === 0) {
            container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-muted);">No completed tasks found for this project.</div>';
            return;
        }

        const dates = STATE.activeTasks.map(t => new Date(t.completed_at));
        const min = new Date(Math.min(...dates)), max = new Date();
        let curr = new Date(min.getFullYear(), min.getMonth(), 1);

        while (curr <= max) {
            const wrapper = document.createElement('div');
            wrapper.className = 'heatmap-month-wrapper';
            const label = document.createElement('div');
            label.className = 'heatmap-month-label';
            const monthKey = `${curr.getFullYear()}-${String(curr.getMonth()+1).padStart(2,'0')}`;
            label.innerText = curr.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            label.onclick = () => window.setFilter('MONTH', monthKey);
            
            const grid = document.createElement('div');
            grid.className = 'calendar-grid';
            const days = new Date(curr.getFullYear(), curr.getMonth()+1, 0).getDate();
            const offset = new Date(curr.getFullYear(), curr.getMonth(), 1).getDay();

            for(let i=0; i<offset; i++) grid.appendChild(Object.assign(document.createElement('div'), {className:'cal-day empty'}));
            for(let d=1; d<=days; d++) {
                const ds = `${curr.getFullYear()}-${String(curr.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const count = STATE.taskMap[ds] || 0;
                const day = document.createElement('div');
                const heat = count === 0 ? 0 : Math.min(5, Math.ceil(count/3));
                day.className = `cal-day heat-${heat}`;
                day.innerText = d;
                day.onclick = () => window.setFilter('DAY', ds);
                grid.appendChild(day);
            }
            wrapper.append(label, grid);
            container.appendChild(wrapper);
            curr.setMonth(curr.getMonth()+1);
        }
    }

    window.setFilter = function(type, val) {
        STATE.filterType = type; STATE.filterValue = val;
        document.getElementById('filter-badge').innerText = val || "All Time";
        document.getElementById('btn-reset').classList.toggle('hidden', type === 'ALL');
        
        if (type === 'ALL') {
            STATE.filteredTasks = [...STATE.activeTasks];
        } else if (type === 'MONTH') {
            STATE.filteredTasks = STATE.activeTasks.filter(t => getLocalISODate(t.completed_at).startsWith(val));
        } else if (type === 'DAY') {
            STATE.filteredTasks = STATE.activeTasks.filter(t => getLocalISODate(t.completed_at) === val);
        }

        updateStats();
        renderTimeline();
        renderProjectBreakdown(); 
        renderLabelBreakdown();
        renderTaskList();
    }

    function renderProjectBreakdown() {
        const container = document.getElementById('project-breakdown-list');
        container.innerHTML = '';

        if(STATE.filteredTasks.length === 0) {
            container.innerHTML = '<div style="color:var(--text-muted); font-size:12px;">No tasks in this period.</div>';
            return;
        }

        const counts = {};
        STATE.filteredTasks.forEach(t => {
            const pid = t.project_id || 'unknown';
            counts[pid] = (counts[pid] || 0) + 1;
        });

        const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
        const maxVal = sorted[0][1];

        sorted.forEach(([pid, count]) => {
            const name = STATE.projectMap[pid] || 'Deleted Projects';
            const color = getProjectColor(pid, name);
            const percent = (count / maxVal) * 100;

            const row = document.createElement('div');
            row.className = 'proj-row';
            row.innerHTML = `
                <div class="proj-color" style="background:${color}"></div>
                <div class="proj-name" title="${name}">${name}</div>
                <div class="proj-bar-track"><div class="proj-bar-fill" style="width:${percent}%; background:${color}"></div></div>
                <div class="proj-count">${count}</div>
            `;
            container.appendChild(row);
        });
    }

    function renderLabelBreakdown() {
        const container = document.getElementById('label-breakdown-list');
        container.innerHTML = '';

        if(STATE.filteredTasks.length === 0) {
            container.innerHTML = '<div style="color:var(--text-muted); font-size:12px;">No tasks in this period.</div>';
            return;
        }

        const counts = {};
        let hasLabels = false;

        STATE.filteredTasks.forEach(t => {
            if (t.labels && t.labels.length > 0) {
                t.labels.forEach(lid => {
                    const name = STATE.labelMap[lid] || 'Unknown';
                    counts[name] = (counts[name] || 0) + 1;
                    hasLabels = true;
                });
            }
            const textTags = extractTagsFromContent(t.content);
            textTags.forEach(name => {
                counts[name] = (counts[name] || 0) + 1;
                hasLabels = true;
            });
        });

        if (!hasLabels) {
            container.innerHTML = '<div style="color:var(--text-muted); font-size:12px;">No tagged tasks in this period.</div>';
            return;
        }

        const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
        const maxVal = sorted[0][1];

        sorted.forEach(([name, count]) => {
            let color = generateColorHash(name);
            for(const [lid, lname] of Object.entries(STATE.labelMap)) {
                if(lname === name) {
                    color = getLabelColor(lid, name);
                    break;
                }
            }
            const percent = (count / maxVal) * 100;
            const row = document.createElement('div');
            row.className = 'proj-row';
            row.innerHTML = `
                <div class="proj-color" style="background:${color}; border-radius: 3px;"></div>
                <div class="proj-name" title="${name}">${name}</div>
                <div class="proj-bar-track"><div class="proj-bar-fill" style="width:${percent}%; background:${color}"></div></div>
                <div class="proj-count">${count}</div>
            `;
            container.appendChild(row);
        });
    }

    function updateStats() {
        document.getElementById('stat-count').innerText = STATE.filteredTasks.length.toLocaleString();
        const days = new Set(STATE.filteredTasks.map(t => getLocalISODate(t.completed_at))).size || 1;
        document.getElementById('stat-avg').innerText = (STATE.filteredTasks.length / days).toFixed(1);
    }

    function renderTimeline() {
        const type = STATE.filterType;
        let labels = [];
        let dataMap = {}; 

        if (type === 'ALL') {
             const dates = STATE.activeTasks.map(t => new Date(t.completed_at));
             if(dates.length === 0) {
                 drawStackedChart('chart-timeline', [], []);
                 return;
             }
             let curr = new Date(Math.min(...dates));
             curr.setDate(1); 
             const end = new Date(); 
             while (curr <= end) {
                const k = `${curr.getFullYear()}-${String(curr.getMonth()+1).padStart(2,'0')}`;
                labels.push(k); 
                dataMap[k] = {};
                curr.setMonth(curr.getMonth() + 1);
             }
             document.getElementById('chart-title-timeline').innerText = "History by Month";

        } else if (type === 'MONTH') {
             const [y, m] = STATE.filterValue.split('-');
             const daysInMonth = new Date(y, m, 0).getDate();
             for(let d=1; d<=daysInMonth; d++) {
                const k = `${y}-${m}-${String(d).padStart(2,'0')}`;
                labels.push(k); 
                dataMap[k] = {};
             }
             document.getElementById('chart-title-timeline').innerText = "Daily Breakdown";

        } else {
             for(let i=0; i<24; i++) {
                const k = `${String(i).padStart(2,'0')}:00`;
                labels.push(k); 
                dataMap[k] = {};
             }
             document.getElementById('chart-title-timeline').innerText = "Hourly Breakdown";
        }

        const allProjectNames = new Set();
        const nameToPidMap = {}; 

        STATE.filteredTasks.forEach(t => {
            let k;
            if (type === 'ALL') k = getLocalISODate(t.completed_at).substring(0, 7);
            else if (type === 'MONTH') k = getLocalISODate(t.completed_at);
            else k = `${String(new Date(t.completed_at).getHours()).padStart(2,'0')}:00`;

            if (dataMap[k]) {
                const pid = t.project_id || 'unknown';
                const name = STATE.projectMap[pid] || 'Deleted Projects';
                
                allProjectNames.add(name);
                if (!nameToPidMap[name]) nameToPidMap[name] = pid; 
                
                dataMap[k][name] = (dataMap[k][name] || 0) + 1;
            }
        });

        const datasets = Array.from(allProjectNames).map(name => {
            const pid = nameToPidMap[name];
            return {
                label: name,
                data: labels.map(l => dataMap[l][name] || 0),
                backgroundColor: getProjectColor(pid, name),
                stack: 'combined',
                barPercentage: 0.8,
                categoryPercentage: 0.9
            };
        });

        datasets.sort((a,b) => a.label.localeCompare(b.label));
        drawStackedChart('chart-timeline', labels, datasets);
    }

    function generateTaskHTML(t) {
         const labelSpans = (t.labels || []).map(lid => {
            const lname = STATE.labelMap[lid] || '';
            return lname ? `<span style="font-size:9px; background:#eee; color:#555; padding:2px 5px; border-radius:3px; margin-left:5px;">#${lname}</span>` : '';
        }).join('');
        
        const contentHtml = t.content.replace(/(@[a-zA-Z0-9_]+)/g, '<span style="color:#e44232; font-weight:bold;">$1</span>');

        return `
            <div class="task-item">
                <div class="task-content">
                    ${contentHtml}
                    ${labelSpans}
                </div>
                <div class="task-project">${STATE.projectMap[t.project_id] || 'Deleted Projects'}</div>
            </div>
        `;
    }

    function renderTaskList() {
        const card = document.getElementById('tasks-detail-card');
        const list = document.getElementById('tasks-list');
        
        if (STATE.filterType !== 'DAY' && STATE.filterType !== 'MONTH') { 
            card.classList.add('hidden'); return; 
        }
        card.classList.remove('hidden');

        document.getElementById('tasks-count-badge').innerText = `${STATE.filteredTasks.length} tasks`;

        if (STATE.filterType === 'DAY') {
            document.getElementById('tasks-detail-title').innerText = `Tasks on ${STATE.filterValue}`;
            list.innerHTML = STATE.filteredTasks.map(t => generateTaskHTML(t)).join('');
        } 
        else if (STATE.filterType === 'MONTH') {
            document.getElementById('tasks-detail-title').innerText = `History for ${new Date(STATE.filterValue + '-01').toLocaleDateString(undefined, {month:'long', year:'numeric'})}`;
            
            const groups = {};
            STATE.filteredTasks.forEach(t => {
                const date = getLocalISODate(t.completed_at);
                if(!groups[date]) groups[date] = [];
                groups[date].push(t);
            });

            const sortedDates = Object.keys(groups).sort();

            list.innerHTML = sortedDates.map(date => {
                const prettyDate = new Date(date).toLocaleDateString(undefined, {weekday:'short', month:'short', day:'numeric'});
                const tasksHtml = groups[date].map(t => generateTaskHTML(t)).join('');
                return `
                    <div style="margin-bottom: 25px;">
                        <h4 style="margin:0 0 10px 0; color:var(--text-muted); border-bottom:1px solid var(--border); padding-bottom:5px; font-size:12px; text-transform:uppercase;">${prettyDate}</h4>
                        ${tasksHtml}
                    </div>
                `;
            }).join('');
        }
    }

    function drawStackedChart(id, labels, datasets) {
        const ctx = document.getElementById(id).getContext('2d');
        if(STATE.charts[id]) STATE.charts[id].destroy();
        STATE.charts[id] = new Chart(ctx, {
            type: 'bar', 
            data: { labels, datasets },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                interaction: { mode: 'index', intersect: false },
                plugins: { 
                    legend: { display: true, position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        filter: function(tooltipItem) {
                            return tooltipItem.raw > 0;
                        },
                        itemSort: function(a, b) {
                            return b.raw - a.raw;
                        }
                    }
                },
                scales: {
                    x: { stacked: true, grid: { display: false } },
                    y: { stacked: true, beginAtZero: true }
                }
            }
        });
    }

    function drawCommunityChart(id, labels, data) {
        const ctx = document.getElementById(id).getContext('2d');
        if(STATE.charts[id]) STATE.charts[id].destroy();
        STATE.charts[id] = new Chart(ctx, {
            type: 'line', data: { labels, datasets: [{ data, borderColor: '#e44232', fill: true, tension: 0.4 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: false } }
        });
    }

    window.resetFilter = () => window.setFilter('ALL', null);
    window.openCommunityModal = () => document.getElementById('community-modal').classList.remove('hidden');
    window.closeCommunityModal = () => document.getElementById('community-modal').classList.add('hidden');
    window.toggleTheme = () => {
        const dark = document.body.getAttribute('data-theme') !== 'dark';
        window.applyTheme(dark ? 'dark' : 'light');
    };
    window.applyTheme = (t) => {
        document.body.setAttribute('data-theme', t);
        localStorage.setItem('theme', t);
        document.getElementById('theme-icon').className = t === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
    };
    window.logout = () => { localStorage.clear(); location.reload(); };
    window.resyncData = () => {
        document.getElementById('loading-msg').innerText = "Syncing...";
        window.initFetch(true);
    };
</script>
</body>
</html>
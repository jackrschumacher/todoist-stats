<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, update, increment, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCtr9BAKgKj4eHqk5lCaDlrASZubFncYqA",
        authDomain: "todoist-stats-cd36f.firebaseapp.com",
        databaseURL: "https://todoist-stats-cd36f-default-rtdb.firebaseio.com",
        projectId: "todoist-stats-cd36f",
        storageBucket: "todoist-stats-cd36f.firebasestorage.app",
        messagingSenderId: "836832717528",
        appId: "1:836832717528:web:e01ff49d10969d429e05ad"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const API_URL = 'https://api.todoist.com/sync/v9/completed/get_all';
    
    let STATE = {
        allTasks: [], filteredTasks: [], taskMap: {}, projectMap: {}, charts: {}, filterType: 'ALL', filterValue: null, isAuthReady: false
    };

    // Global Stats Listener
    onValue(ref(db, 'global_stats'), (snapshot) => {
        const data = snapshot.val(); if (!data) return;
        document.getElementById('global-tasks').innerText = (data.tasks_processed || 0).toLocaleString();
        document.getElementById('global-projects').innerText = (data.projects_processed || 0).toLocaleString();
        document.getElementById('global-wrappeds').innerText = (data.wrappeds_generated || 0).toLocaleString();
        document.getElementById('comm-total').innerText = (data.tasks_processed || 0).toLocaleString();
        document.getElementById('comm-projects').innerText = (data.projects_processed || 0).toLocaleString();
        const totalDays = data.total_days_logged || 1;
        document.getElementById('comm-avg').innerText = (data.tasks_processed / totalDays).toFixed(1);
    });

    onValue(ref(db, 'community_monthly'), (snapshot) => {
        const data = snapshot.val(); if (!data) return;
        const keys = Object.keys(data).sort();
        drawCommunityChart('comm-chart', keys, keys.map(k => data[k]));
    });

    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("ðŸ”¥ Firebase Auth Ready:", user.uid);
            STATE.isAuthReady = true;
            const token = localStorage.getItem('todoist_token');
            if (token) {
                document.getElementById('api-token').value = token;
                window.initFetch();
            }
        } else { 
            console.log("...Signing in anonymously...");
            signInAnonymously(auth).catch(console.error); 
        }
    });

    window.onload = () => {
        if(localStorage.getItem('theme') === 'dark') window.applyTheme('dark');
        const projCache = localStorage.getItem('todoist_projects_cache');
        if (projCache) STATE.projectMap = JSON.parse(projCache);
    };

    window.initFetch = async function(resync = false) {
        const token = document.getElementById('api-token').value.trim();
        if (!token) return;

        if (!resync) {
            const cached = localStorage.getItem('todoist_task_cache');
            if (cached) {
                STATE.allTasks = JSON.parse(cached);
                processData();
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('view-dashboard').classList.remove('hidden');
                // Try to sync stats in background if auth is ready, else wait
                if(STATE.isAuthReady) calculateDeltas();
                else setTimeout(() => { if(STATE.isAuthReady) calculateDeltas(); }, 2000);
                return;
            }
        }

        document.getElementById('loading-ui').classList.remove('hidden');
        STATE.allTasks = [];
        let offset = 0, hasMore = true;

        try {
            // Fetch Projects
            const projRes = await fetch('https://api.todoist.com/sync/v9/sync', {
                method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ sync_token: '*', resource_types: ['projects'] })
            });
            const projData = await projRes.json();
            projData.projects.forEach(p => STATE.projectMap[p.id] = p.name);
            localStorage.setItem('todoist_projects_cache', JSON.stringify(STATE.projectMap));

            while(hasMore) {
                const res = await fetch(`${API_URL}?limit=200&offset=${offset}`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if(data.items.length > 0) {
                    STATE.allTasks = STATE.allTasks.concat(data.items);
                    offset += 200;
                    document.getElementById('load-count').innerText = STATE.allTasks.length;
                } else { hasMore = false; }
            }

            localStorage.setItem('todoist_token', token);
            localStorage.setItem('todoist_task_cache', JSON.stringify(STATE.allTasks));
            processData();
            
            // Wait slightly to ensure Auth is ready before writing
            if (STATE.isAuthReady) calculateDeltas();
            else setTimeout(() => calculateDeltas(), 1000);

            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-dashboard').classList.remove('hidden');
        } catch (e) { alert("Fetch failed: " + e.message); }
        document.getElementById('loading-ui').classList.add('hidden');
    }

    // UPDATED DELTA FUNCTION
    function calculateDeltas() {
        if (!STATE.isAuthReady) {
            console.warn("Auth not ready, skipping stats sync.");
            return;
        }

        const lastStr = localStorage.getItem('todoist_last_sync_stats');
        const last = lastStr ? JSON.parse(lastStr) : { tasks: 0, projects: 0 };
        const currentTasks = STATE.allTasks.length;
        const currentProjects = Object.keys(STATE.projectMap).length;

        console.log(`Checking Sync: Last Projects: ${last.projects}, Current: ${currentProjects}`);

        if (currentTasks > last.tasks || currentProjects > last.projects) {
            const updates = {};
            if (currentTasks > last.tasks) updates['global_stats/tasks_processed'] = increment(currentTasks - last.tasks);
            if (currentProjects > last.projects) updates['global_stats/projects_processed'] = increment(currentProjects - last.projects);
            
            const months = {};
            STATE.allTasks.forEach(t => {
                const m = t.completed_at.substring(0, 7);
                months[m] = (months[m] || 0) + 1;
            });
            for(const [m, v] of Object.entries(months)) {
                // Simple monthly increment (approximate for community activity)
                if(v > 0) updates[`community_monthly/${m}`] = increment(1); 
            }

            update(ref(db), updates)
                .then(() => {
                    console.log("âœ… Stats synced to Firebase!");
                    // ONLY update local storage if Firebase write succeeded
                    localStorage.setItem('todoist_last_sync_stats', JSON.stringify({ tasks: currentTasks, projects: currentProjects }));
                })
                .catch((e) => {
                    console.error("âŒ Stats sync failed:", e);
                });
        } else {
            console.log("No new stats to sync.");
        }
    }

    // Emergency manual trigger
    window.forceProjectSync = function() {
        localStorage.removeItem('todoist_last_sync_stats');
        calculateDeltas();
    }

    function processData() {
        STATE.taskMap = {};
        STATE.allTasks.forEach(t => {
            const d = t.completed_at.substring(0, 10);
            STATE.taskMap[d] = (STATE.taskMap[d] || 0) + 1;
        });
        renderHeatmap();
        window.resetFilter();
    }

    function renderHeatmap() {
        const container = document.getElementById('full-heatmap-content');
        container.innerHTML = '';
        const dates = STATE.allTasks.map(t => new Date(t.completed_at));
        const min = new Date(Math.min(...dates)), max = new Date();
        let curr = new Date(min.getFullYear(), min.getMonth(), 1);

        while (curr <= max) {
            const wrapper = document.createElement('div');
            wrapper.className = 'heatmap-month-wrapper';
            const label = document.createElement('div');
            label.className = 'heatmap-month-label';
            const monthKey = `${curr.getFullYear()}-${String(curr.getMonth()+1).padStart(2,'0')}`;
            label.innerText = curr.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            label.onclick = () => window.setFilter('MONTH', monthKey);
            
            const grid = document.createElement('div');
            grid.className = 'calendar-grid';
            const days = new Date(curr.getFullYear(), curr.getMonth()+1, 0).getDate();
            const offset = new Date(curr.getFullYear(), curr.getMonth(), 1).getDay();

            for(let i=0; i<offset; i++) grid.appendChild(Object.assign(document.createElement('div'), {className:'cal-day empty'}));
            for(let d=1; d<=days; d++) {
                const ds = `${curr.getFullYear()}-${String(curr.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const count = STATE.taskMap[ds] || 0;
                const day = document.createElement('div');
                const heat = count === 0 ? 0 : Math.min(5, Math.ceil(count/3));
                day.className = `cal-day heat-${heat}`;
                day.innerText = d;
                day.onclick = () => window.setFilter('DAY', ds);
                grid.appendChild(day);
            }
            wrapper.append(label, grid);
            container.appendChild(wrapper);
            curr.setMonth(curr.getMonth()+1);
        }
    }

    window.setFilter = function(type, val) {
        STATE.filterType = type; STATE.filterValue = val;
        document.getElementById('filter-badge').innerText = val || "All Time";
        document.getElementById('btn-reset').classList.toggle('hidden', type === 'ALL');
        
        if (type === 'ALL') STATE.filteredTasks = [...STATE.allTasks];
        else if (type === 'MONTH') STATE.filteredTasks = STATE.allTasks.filter(t => t.completed_at.startsWith(val));
        else if (type === 'DAY') STATE.filteredTasks = STATE.allTasks.filter(t => t.completed_at.startsWith(val));

        updateStats();
        renderTimeline();
        renderTaskList();
    }

    function updateStats() {
        document.getElementById('stat-count').innerText = STATE.filteredTasks.length.toLocaleString();
        const days = new Set(STATE.filteredTasks.map(t => t.completed_at.substring(0,10))).size || 1;
        document.getElementById('stat-avg').innerText = (STATE.filteredTasks.length / days).toFixed(1);
    }

    function renderTimeline() {
        const map = {};
        STATE.filteredTasks.forEach(t => {
            const k = STATE.filterType === 'DAY' ? t.completed_at.substring(11, 13) + ":00" : t.completed_at.substring(0, 10);
            map[k] = (map[k] || 0) + 1;
        });
        const labels = Object.keys(map).sort();
        drawChart('chart-timeline', 'bar', labels, labels.map(l => map[l]));
    }

    function renderTaskList() {
        const card = document.getElementById('tasks-detail-card');
        const list = document.getElementById('tasks-list');
        if (STATE.filterType !== 'DAY') { card.classList.add('hidden'); return; }
        card.classList.remove('hidden');
        document.getElementById('tasks-detail-title').innerText = `Tasks on ${STATE.filterValue}`;
        document.getElementById('tasks-count-badge').innerText = STATE.filteredTasks.length;
        list.innerHTML = STATE.filteredTasks.map(t => `
            <div class="task-item">
                <div class="task-content">${t.content}</div>
                <div class="task-project">${STATE.projectMap[t.project_id] || 'Inbox'}</div>
            </div>
        `).join('');
    }

    function drawChart(id, type, labels, data) {
        const ctx = document.getElementById(id).getContext('2d');
        if(STATE.charts[id]) STATE.charts[id].destroy();
        STATE.charts[id] = new Chart(ctx, {
            type, data: { labels, datasets: [{ data, backgroundColor: '#e44232' }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: false } }
        });
    }

    function drawCommunityChart(id, labels, data) {
        const ctx = document.getElementById(id).getContext('2d');
        if(STATE.charts[id]) STATE.charts[id].destroy();
        STATE.charts[id] = new Chart(ctx, {
            type: 'line', data: { labels, datasets: [{ data, borderColor: '#e44232', fill: true, tension: 0.4 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: false } }
        });
    }

    window.resetFilter = () => window.setFilter('ALL', null);
    window.openCommunityModal = () => document.getElementById('community-modal').classList.remove('hidden');
    window.closeCommunityModal = () => document.getElementById('community-modal').classList.add('hidden');
    window.toggleTheme = () => {
        const dark = document.body.getAttribute('data-theme') !== 'dark';
        window.applyTheme(dark ? 'dark' : 'light');
    };
    window.applyTheme = (t) => {
        document.body.setAttribute('data-theme', t);
        localStorage.setItem('theme', t);
        document.getElementById('theme-icon').className = t === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
    };
    window.logout = () => { localStorage.clear(); location.reload(); };
    window.resyncData = () => window.initFetch(true);
</script>